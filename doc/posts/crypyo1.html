<!DOCTYPE html>

<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="mobile-web-app-capable" content="yes">
    <title>
        CRYPTO1: 密码分析学 (门禁卡破解) - CodiMD
    </title>
    <link rel="icon" type="image/png" href="https://codimd.wuhanstudio.cc/favicon.png">
    <link rel="apple-touch-icon" href="https://codimd.wuhanstudio.cc/apple-touch-icon.png">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.0/css/bootstrap.min.css" integrity="sha256-H0KfTigpUV+0/5tn2HXC0CPwhhDhWgSawJdnFd0CGCo=" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fork-awesome/1.1.3/css/fork-awesome.min.css" integrity="sha256-ZhApazu+kejqTYhMF+1DzNKjIzP7KXu6AzyXcC1gMus=" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/ionicons/2.0.1/css/ionicons.min.css" integrity="sha256-3iu9jgsy9TpTwXKb7bNQzqWekRX7pPK+2OLj3R922fo=" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.5.1/themes/prism.min.css" integrity="sha256-vtR0hSWRc3Tb26iuN2oZHt3KRUomwTufNIf5/4oeCyg=" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github-gist.min.css" integrity="sha256-tAflq+ymku3Khs+I/WcAneIlafYgDiOQ9stIHH985Wo=" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/emojify.js/1.1.0/css/basic/emojify.min.css" integrity="sha256-UOrvMOsSDSrW6szVLe8ZDZezBxh5IoIfgTwdNDgTjiU=" crossorigin="anonymous" />
    <style>
        @import url(https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,400italic,600,600italic,300italic,300|Source+Serif+Pro|Source+Code+Pro:400,300,500&subset=latin,latin-ext);.markdown-body{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif,Apple Color Emoji,Segoe UI Emoji,Segoe UI Symbol;font-size:16px;line-height:1.5;word-wrap:break-word}.markdown-body:after,.markdown-body:before{display:table;content:""}.markdown-body:after{clear:both}.markdown-body>:first-child{margin-top:0!important}.markdown-body>:last-child{margin-bottom:0!important}.markdown-body a:not([href]){color:inherit;text-decoration:none}.markdown-body .absent{color:#c00}.markdown-body .anchor{float:left;padding-right:4px;margin-left:-20px;line-height:1}.markdown-body .anchor:focus{outline:none}.markdown-body blockquote,.markdown-body dl,.markdown-body ol,.markdown-body p,.markdown-body pre,.markdown-body table,.markdown-body ul{margin-top:0;margin-bottom:16px}.markdown-body hr{height:.25em;padding:0;margin:24px 0;background-color:#e7e7e7;border:0}.markdown-body blockquote{padding:0 1em;color:#777;border-left:.25em solid #ddd}.night .markdown-body blockquote{color:#bcbcbc}.markdown-body blockquote>:first-child{margin-top:0}.markdown-body blockquote>:last-child{margin-bottom:0}.markdown-body .loweralpha{list-style-type:lower-alpha}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin-top:24px;margin-bottom:16px;font-weight:600;line-height:1.25}.night .markdown-body h1,.night .markdown-body h2,.night .markdown-body h3,.night .markdown-body h4,.night .markdown-body h5,.night .markdown-body h6{color:#ddd}.markdown-body h1 .fa-link,.markdown-body h2 .fa-link,.markdown-body h3 .fa-link,.markdown-body h4 .fa-link,.markdown-body h5 .fa-link,.markdown-body h6 .fa-link{color:#000;vertical-align:middle;visibility:hidden;font-size:16px}.night .markdown-body h1 .fa-link,.night .markdown-body h2 .fa-link,.night .markdown-body h3 .fa-link,.night .markdown-body h4 .fa-link,.night .markdown-body h5 .fa-link,.night .markdown-body h6 .fa-link{color:#fff}.markdown-body h1:hover .anchor,.markdown-body h2:hover .anchor,.markdown-body h3:hover .anchor,.markdown-body h4:hover .anchor,.markdown-body h5:hover .anchor,.markdown-body h6:hover .anchor{text-decoration:none}.markdown-body h1:hover .anchor .fa-link,.markdown-body h2:hover .anchor .fa-link,.markdown-body h3:hover .anchor .fa-link,.markdown-body h4:hover .anchor .fa-link,.markdown-body h5:hover .anchor .fa-link,.markdown-body h6:hover .anchor .fa-link{visibility:visible}.markdown-body h1 code,.markdown-body h1 tt,.markdown-body h2 code,.markdown-body h2 tt,.markdown-body h3 code,.markdown-body h3 tt,.markdown-body h4 code,.markdown-body h4 tt,.markdown-body h5 code,.markdown-body h5 tt,.markdown-body h6 code,.markdown-body h6 tt{font-size:inherit}.markdown-body h1{font-size:2em}.markdown-body h1,.markdown-body h2{padding-bottom:.3em;border-bottom:1px solid #eee}.markdown-body h2{font-size:1.5em}.markdown-body h3{font-size:1.25em}.markdown-body h4{font-size:1em}.markdown-body h5{font-size:.875em}.markdown-body h6{font-size:.85em;color:#777}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol.no-list,.markdown-body ul.no-list{padding:0;list-style-type:none}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:0;margin-bottom:0}.markdown-body li>p{margin-top:16px}.markdown-body li+li{margin-top:.25em}.markdown-body dl{padding:0}.markdown-body dl dt{padding:0;margin-top:16px;font-size:1em;font-style:italic;font-weight:700}.markdown-body dl dd{padding:0 16px;margin-bottom:16px}.markdown-body table{display:block;width:100%;overflow:auto;word-break:normal;word-break:keep-all}.markdown-body table th{font-weight:700}.markdown-body table td,.markdown-body table th{padding:6px 13px;border:1px solid #ddd}.markdown-body table tr{background-color:#fff;border-top:1px solid #ccc}.night .markdown-body table tr{background-color:#5f5f5f}.markdown-body table tr:nth-child(2n){background-color:#f8f8f8}.night .markdown-body table tr:nth-child(2n){background-color:#4f4f4f}.markdown-body img{max-width:100%;box-sizing:content-box;background-color:#fff}.markdown-body img[align=right]{padding-left:20px}.markdown-body img[align=left]{padding-right:20px}.markdown-body .emoji{max-width:none;vertical-align:text-top;background-color:transparent}.markdown-body span.frame{display:block;overflow:hidden}.markdown-body span.frame>span{display:block;float:left;width:auto;padding:7px;margin:13px 0 0;overflow:hidden;border:1px solid #ddd}.markdown-body span.frame span img{display:block;float:left}.markdown-body span.frame span span{display:block;padding:5px 0 0;clear:both;color:#333}.markdown-body span.align-center{display:block;overflow:hidden;clear:both}.markdown-body span.align-center>span{display:block;margin:13px auto 0;overflow:hidden;text-align:center}.markdown-body span.align-center span img{margin:0 auto;text-align:center}.markdown-body span.align-right{display:block;overflow:hidden;clear:both}.markdown-body span.align-right>span{display:block;margin:13px 0 0;overflow:hidden;text-align:right}.markdown-body span.align-right span img{margin:0;text-align:right}.markdown-body span.float-left{display:block;float:left;margin-right:13px;overflow:hidden}.markdown-body span.float-left span{margin:13px 0 0}.markdown-body span.float-right{display:block;float:right;margin-left:13px;overflow:hidden}.markdown-body span.float-right>span{display:block;margin:13px auto 0;overflow:hidden;text-align:right}.markdown-body code,.markdown-body tt{padding:.2em 0;margin:0;font-size:85%;background-color:rgba(0,0,0,.04);border-radius:3px}.night .markdown-body code,.night .markdown-body tt{color:#eee;background-color:hsla(0,0%,90.2%,.36)}.markdown-body code:after,.markdown-body code:before,.markdown-body tt:after,.markdown-body tt:before{letter-spacing:-.2em;content:"\A0"}.markdown-body code br,.markdown-body tt br{display:none}.markdown-body del code{text-decoration:inherit}.markdown-body pre{word-wrap:normal}.markdown-body pre>code{padding:0;margin:0;font-size:100%;word-break:normal;white-space:pre;background:transparent;border:0}.markdown-body .highlight{margin-bottom:16px}.markdown-body .highlight pre{margin-bottom:0;word-break:normal}.markdown-body .highlight pre,.markdown-body pre{padding:16px;overflow:auto;font-size:85%;line-height:1.45;background-color:#f7f7f7;border-radius:3px}.markdown-body pre code,.markdown-body pre tt{display:inline;max-width:auto;padding:0;margin:0;overflow:visible;line-height:inherit;word-wrap:normal;background-color:transparent;border:0}.markdown-body pre code:after,.markdown-body pre code:before,.markdown-body pre tt:after,.markdown-body pre tt:before{content:normal}.markdown-body .csv-data td,.markdown-body .csv-data th{padding:5px;overflow:hidden;font-size:12px;line-height:1;text-align:left;white-space:nowrap}.markdown-body .csv-data .blob-line-num{padding:10px 8px 9px;text-align:right;background:#fff;border:0}.markdown-body .csv-data tr{border-top:0}.markdown-body .csv-data th{font-weight:700;background:#f8f8f8;border-top:0}.markdown-body kbd{display:inline-block;padding:3px 5px;font-size:11px;line-height:10px;color:#555;vertical-align:middle;background-color:#fcfcfc;border:1px solid;border-color:#ccc #ccc #bbb;border-radius:3px;box-shadow:inset 0 -1px 0 #bbb}.news .alert .markdown-body blockquote{padding:0 0 0 40px;border:0}.activity-tab .news .alert .commits,.activity-tab .news .markdown-body blockquote{padding-left:0}.task-list-item{list-style-type:none}.task-list-item label{font-weight:400}.task-list-item.enabled label{cursor:pointer}.task-list-item+.task-list-item{margin-top:3px}.task-list-item-checkbox{float:left;margin:.31em 0 .2em -1.3em!important;vertical-align:middle;cursor:default!important}.markdown-body{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica Neue,Helvetica,Arial,sans-serif,Apple Color Emoji,Segoe UI Emoji,Segoe UI Symbol;padding-top:40px;padding-bottom:40px;max-width:758px;overflow:visible!important}.markdown-body pre{border:inherit!important}.night .markdown-body pre{filter:invert(100%)}.markdown-body code{color:inherit!important}.markdown-body pre code .wrapper{display:-webkit-inline-flex;display:-moz-inline-flex;display:-ms-inline-flex;display:-o-inline-flex;display:inline-flex}.markdown-body pre code .gutter{float:left;overflow:hidden;-webkit-user-select:none;user-select:none}.markdown-body pre code .gutter.linenumber{text-align:right;position:relative;display:inline-block;cursor:default;z-index:4;padding:0 8px 0 0;min-width:20px;box-sizing:content-box;color:#afafaf!important;border-right:3px solid #6ce26c!important}.markdown-body pre code .gutter.linenumber>span:before{content:attr(data-linenumber)}.markdown-body pre code .code{float:left;margin:0 0 0 16px}.markdown-body .gist .line-numbers{border-left:none;border-top:none;border-bottom:none}.markdown-body .gist .line-data{border:none}.markdown-body .gist table{border-spacing:0;border-collapse:inherit!important}.night .markdown-body .gist table tr:nth-child(2n){background-color:#ddd}.markdown-body code[data-gist-id]{background:none;padding:0;filter:invert(100%)}.markdown-body code[data-gist-id]:after,.markdown-body code[data-gist-id]:before{content:""}.markdown-body code[data-gist-id] .blob-num{border:unset}.markdown-body code[data-gist-id] table{overflow:unset;margin-bottom:unset}.markdown-body code[data-gist-id] table tr{background:unset}.markdown-body[dir=rtl] pre{direction:ltr}.markdown-body[dir=rtl] code{direction:ltr;unicode-bidi:embed}.markdown-body .alert>p{margin-bottom:0}.markdown-body pre.abc,.markdown-body pre.flow-chart,.markdown-body pre.graphviz,.markdown-body pre.mermaid,.markdown-body pre.sequence-diagram,.markdown-body pre.vega{text-align:center;background-color:inherit;border-radius:0;white-space:inherit}.night .markdown-body pre.graphviz .graph>polygon{fill:#333}.night .markdown-body pre.mermaid .sectionTitle,.night .markdown-body pre.mermaid .titleText,.night .markdown-body pre.mermaid text{fill:#fff}.markdown-body pre.abc>code,.markdown-body pre.flow-chart>code,.markdown-body pre.graphviz>code,.markdown-body pre.mermaid>code,.markdown-body pre.sequence-diagram>code,.markdown-body pre.vega>code{text-align:left}.markdown-body pre.abc>svg,.markdown-body pre.flow-chart>svg,.markdown-body pre.graphviz>svg,.markdown-body pre.mermaid>svg,.markdown-body pre.sequence-diagram>svg,.markdown-body pre.vega>svg{max-width:100%;height:100%}.night .markdown-body .abc path{fill:#eee}.night .markdown-body .abc path.note_selected{fill:##4DD0E1}.night tspan{fill:#fefefe}.night pre rect{fill:transparent}.night pre.flow-chart path,.night pre.flow-chart rect{stroke:#fff}.markdown-body pre>code.wrap{white-space:pre-wrap;white-space:-moz-pre-wrap;white-space:-pre-wrap;white-space:-o-pre-wrap;word-wrap:break-word}.markdown-body .alert>p,.markdown-body .alert>ul{margin-bottom:0}.markdown-body summary{display:list-item}.markdown-body summary:focus{outline:none}.markdown-body details summary{cursor:pointer}.markdown-body details:not([open])>:not(summary){display:none}.markdown-body figure{margin:1em 40px}.markdown-body img{background-color:transparent}.vimeo,.youtube{cursor:pointer;display:table;text-align:center;background-position:50%;background-repeat:no-repeat;background-size:contain;background-color:#000;overflow:hidden}.vimeo,.youtube{position:relative;width:100%}.youtube{padding-bottom:56.25%}.vimeo img{width:100%;object-fit:contain;z-index:0}.youtube img{object-fit:cover;z-index:0}.vimeo iframe,.youtube iframe,.youtube img{width:100%;height:100%;position:absolute;top:0;left:0}.vimeo iframe,.youtube iframe{vertical-align:middle;z-index:1}.vimeo .icon,.youtube .icon{position:absolute;height:auto;width:auto;top:50%;left:50%;transform:translate(-50%,-50%);color:#fff;opacity:.3;-webkit-transition:opacity .2s;transition:opacity .2s;z-index:0}.vimeo:hover .icon,.youtube:hover .icon{opacity:.6;-webkit-transition:opacity .2s;transition:opacity .2s}.slideshare .inner,.speakerdeck .inner{position:relative;width:100%}.slideshare .inner iframe,.speakerdeck .inner iframe{position:absolute;top:0;bottom:0;left:0;right:0;width:100%;height:100%}.MJX_Assistive_MathML{display:none}.ui-infobar{position:relative;z-index:2;max-width:758px;margin-top:25px;margin-bottom:-25px;color:#777}.toc .invisable-node{list-style-type:none}.ui-toc{position:fixed;bottom:20px;z-index:10000}.ui-toc-label{opacity:.3;background-color:#ccc;border:none}.ui-toc-label,.ui-toc .open .ui-toc-label{-webkit-transition:opacity .2s;transition:opacity .2s}.ui-toc .open .ui-toc-label{opacity:1;color:#fff}.ui-toc-label:focus{opacity:.3;background-color:#ccc;color:#000}.ui-toc-label:hover{opacity:1;background-color:#ccc;-webkit-transition:opacity .2s;transition:opacity .2s}.ui-toc-dropdown{margin-top:23px;margin-bottom:20px;padding-left:10px;padding-right:10px;max-width:45vw;width:25vw;max-height:70vh;overflow:auto;text-align:inherit}.ui-toc-dropdown>.toc{max-height:calc(70vh - 100px);overflow:auto}.ui-toc-dropdown[dir=rtl] .nav{padding-right:0;letter-spacing:.0029em}.ui-toc-dropdown a{overflow:hidden;text-overflow:ellipsis;white-space:pre}.ui-toc-dropdown .nav>li>a{display:block;padding:4px 20px;font-size:13px;font-weight:500;color:#767676}.ui-toc-dropdown .nav>li:first-child:last-child>ul,.ui-toc-dropdown .toc.expand ul{display:block}.ui-toc-dropdown .nav>li>a:focus,.ui-toc-dropdown .nav>li>a:hover{padding-left:19px;color:#000;text-decoration:none;background-color:transparent;border-left:1px solid #000}.night .ui-toc-dropdown .nav>li>a:focus,.night .ui-toc-dropdown .nav>li>a:hover{color:#fff;border-left-color:#fff}.ui-toc-dropdown[dir=rtl] .nav>li>a:focus,.ui-toc-dropdown[dir=rtl] .nav>li>a:hover{padding-right:19px;border-left:none;border-right:1px solid #000}.ui-toc-dropdown .nav>.active:focus>a,.ui-toc-dropdown .nav>.active:hover>a,.ui-toc-dropdown .nav>.active>a{padding-left:18px;font-weight:700;color:#000;background-color:transparent;border-left:2px solid #000}.night .ui-toc-dropdown .nav>.active:focus>a,.night .ui-toc-dropdown .nav>.active:hover>a,.night .ui-toc-dropdown .nav>.active>a{color:#fff;border-left:2px solid #fff}.ui-toc-dropdown[dir=rtl] .nav>.active:focus>a,.ui-toc-dropdown[dir=rtl] .nav>.active:hover>a,.ui-toc-dropdown[dir=rtl] .nav>.active>a{padding-right:18px;border-left:none;border-right:2px solid #000}.ui-toc-dropdown .nav .nav{display:none;padding-bottom:10px}.ui-toc-dropdown .nav>.active>ul{display:block}.ui-toc-dropdown .nav .nav>li>a{padding-top:1px;padding-bottom:1px;padding-left:30px;font-size:12px;font-weight:400}.night .ui-toc-dropdown .nav>li>a{color:#aaa}.ui-toc-dropdown[dir=rtl] .nav .nav>li>a{padding-right:30px}.ui-toc-dropdown .nav .nav>li>ul>li>a{padding-top:1px;padding-bottom:1px;padding-left:40px;font-size:12px;font-weight:400}.ui-toc-dropdown[dir=rtl] .nav .nav>li>ul>li>a{padding-right:40px}.ui-toc-dropdown .nav .nav>li>a:focus,.ui-toc-dropdown .nav .nav>li>a:hover{padding-left:29px}.ui-toc-dropdown[dir=rtl] .nav .nav>li>a:focus,.ui-toc-dropdown[dir=rtl] .nav .nav>li>a:hover{padding-right:29px}.ui-toc-dropdown .nav .nav>li>ul>li>a:focus,.ui-toc-dropdown .nav .nav>li>ul>li>a:hover{padding-left:39px}.ui-toc-dropdown[dir=rtl] .nav .nav>li>ul>li>a:focus,.ui-toc-dropdown[dir=rtl] .nav .nav>li>ul>li>a:hover{padding-right:39px}.ui-toc-dropdown .nav .nav>.active:focus>a,.ui-toc-dropdown .nav .nav>.active:hover>a,.ui-toc-dropdown .nav .nav>.active>a{padding-left:28px;font-weight:500}.ui-toc-dropdown[dir=rtl] .nav .nav>.active:focus>a,.ui-toc-dropdown[dir=rtl] .nav .nav>.active:hover>a,.ui-toc-dropdown[dir=rtl] .nav .nav>.active>a{padding-right:28px}.ui-toc-dropdown .nav .nav>.active>.nav>.active:focus>a,.ui-toc-dropdown .nav .nav>.active>.nav>.active:hover>a,.ui-toc-dropdown .nav .nav>.active>.nav>.active>a{padding-left:38px;font-weight:500}.ui-toc-dropdown[dir=rtl] .nav .nav>.active>.nav>.active:focus>a,.ui-toc-dropdown[dir=rtl] .nav .nav>.active>.nav>.active:hover>a,.ui-toc-dropdown[dir=rtl] .nav .nav>.active>.nav>.active>a{padding-right:38px}.markdown-body[lang^=ja]{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica Neue,Helvetica,Arial,Hiragino Kaku Gothic Pro,"\30D2\30E9\30AE\30CE\89D2\30B4   Pro W3",Osaka,Meiryo,"\30E1\30A4\30EA\30AA",MS Gothic,"\FF2D\FF33   \30B4\30B7\30C3\30AF",sans-serif,Apple Color Emoji,Segoe UI Emoji,Segoe UI Symbol}.ui-toc-dropdown[lang^=ja]{font-family:Source Sans Pro,Helvetica,Arial,Meiryo UI,MS PGothic,"\FF2D\FF33   \FF30\30B4\30B7\30C3\30AF",sans-serif}.markdown-body[lang=zh-tw]{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica Neue,Helvetica,Arial,PingFang TC,Microsoft JhengHei,"\5FAE\8EDF\6B63\9ED1",sans-serif,Apple Color Emoji,Segoe UI Emoji,Segoe UI Symbol}.ui-toc-dropdown[lang=zh-tw]{font-family:Source Sans Pro,Helvetica,Arial,Microsoft JhengHei UI,"\5FAE\8EDF\6B63\9ED1UI",sans-serif}.markdown-body[lang=zh-cn]{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica Neue,Helvetica,Arial,PingFang SC,Microsoft YaHei,"\5FAE\8F6F\96C5\9ED1",sans-serif,Apple Color Emoji,Segoe UI Emoji,Segoe UI Symbol}.ui-toc-dropdown[lang=zh-cn]{font-family:Source Sans Pro,Helvetica,Arial,Microsoft YaHei UI,"\5FAE\8F6F\96C5\9ED1UI",sans-serif}.ui-affix-toc{position:fixed;top:0;max-width:15vw;max-height:70vh;overflow:auto}.back-to-top,.expand-toggle,.go-to-bottom{display:block;padding:4px 10px;margin-top:10px;margin-left:10px;font-size:12px;font-weight:500;color:#999}.back-to-top:focus,.back-to-top:hover,.expand-toggle:focus,.expand-toggle:hover,.go-to-bottom:focus,.go-to-bottom:hover{color:#563d7c;text-decoration:none}.back-to-top,.go-to-bottom{margin-top:0}.ui-user-icon{width:20px;height:20px;display:block;border-radius:3px;margin-top:2px;margin-bottom:2px;margin-right:5px;background-position:50%;background-repeat:no-repeat;background-size:contain}.ui-user-icon.small{width:18px;height:18px;display:inline-block;vertical-align:middle;margin:0 0 .2em}small span{line-height:22px}small .dropdown{display:inline-block}small .dropdown a:focus,small .dropdown a:hover{text-decoration:none}.unselectable{-moz-user-select:none;-khtml-user-select:none;-webkit-user-select:none;-o-user-select:none;user-select:none}.night .navbar{background:#333;border-bottom-color:#333;color:#eee}.night .navbar a{color:#eee}@media print{blockquote,div,img,pre,table{page-break-inside:avoid!important}a[href]:after{font-size:12px!important}}.markdown-body.slides{position:relative;z-index:1;color:#222}.markdown-body.slides:before{content:"";display:block;position:absolute;top:0;left:0;right:0;bottom:0;z-index:-1;background-color:currentColor;box-shadow:0 0 0 50vw}.markdown-body.slides section[data-markdown]{position:relative;margin-bottom:1.5em;background-color:#fff;text-align:center}.markdown-body.slides section[data-markdown] code{text-align:left}.markdown-body.slides section[data-markdown]:before{content:"";display:block;padding-bottom:56.23%}.markdown-body.slides section[data-markdown]>div:first-child{position:absolute;top:50%;left:1em;right:1em;transform:translateY(-50%);max-height:100%;overflow:hidden}.markdown-body.slides section[data-markdown]>ul{display:inline-block}.markdown-body.slides>section>section+section:after{content:"";position:absolute;top:-1.5em;right:1em;height:1.5em;border:3px solid #777}body{font-smoothing:subpixel-antialiased!important;-webkit-font-smoothing:subpixel-antialiased!important;-moz-osx-font-smoothing:auto!important;text-shadow:0 0 1em transparent,1px 1px 1.2px rgba(0,0,0,.004);-webkit-overflow-scrolling:touch;font-family:Source Sans Pro,Helvetica,Arial,sans-serif;letter-spacing:.025em}.focus,:focus{outline:none!important}::-moz-focus-inner{border:0!important}body.modal-open{overflow-y:auto;padding-right:0!important}
    </style>
    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    	<script src="https://cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv.min.js" integrity="sha256-3Jy/GbSLrg0o9y5Z5n1uw0qxZECH7C6OQpVBgNFYa0g=" crossorigin="anonymous"></script>
    	<script src="https://cdnjs.cloudflare.com/ajax/libs/respond.js/1.4.2/respond.min.js" integrity="sha256-g6iAfvZp+nDQ2TdTR/VVKJf3bGro4ub5fvWSWVRi2NE=" crossorigin="anonymous"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/es5-shim/4.5.9/es5-shim.min.js" integrity="sha256-8E4Is26QH0bD52WoQpcB+R/tcWQtpzlCojrybUd7Mxo=" crossorigin="anonymous"></script>
    <![endif]-->
</head>

<body>
    <div id="doc" class="markdown-body container-fluid"><h1 id="CRYPTO1-密码分析学-门禁卡破解" style=""><a class="anchor hidden-xs" href="#CRYPTO1-密码分析学-门禁卡破解" title="CRYPTO1-密码分析学-门禁卡破解"><i class="fa fa-link"></i></a>CRYPTO1: 密码分析学 (门禁卡破解)</h1><blockquote>
<p>介绍 NXP 公司的 NFC 卡加密认证破解过程</p>
</blockquote><p>从 2015 年开始，在国内读本科的时候就有不少同学破解、复制了门禁卡、校园卡。如今已经过去了 8 年，2023 年到英国读博了，不论是学校宿舍，还是市中心宿舍的门禁卡，依旧可以随意破解、复制，甚至伦敦地铁的 Oyster Card 也是同款不安全的设计。</p><p><img src="" alt="img"></p><p>1994 年，NXP 发布了这款不安全的 NFC 卡（ MIFARE Classic EV11K 也称为 M1 卡），接下来风靡全球，公交卡、地铁卡、门禁卡、学生卡都得到了广泛的应用。当然，这张卡的认证、加密算法都是不对外公开的，当初并没有人知道它是不安全的。</p><p>直到 2008 年，才有人利用逆向工程完整复原了卡的所有加密细节，并且公布了一些针对认证过程（Authentication）的攻击 [1]，不过这些攻击并没有威胁到它的核心 Crypto1 加密算法。之后 NXP 公司紧急修复了认证过程的一些漏洞，表示还能继续使用。</p><p>2015 年，很不幸密码分析学得到了发展之后，它的核心 Crypto1 加密算法也被完全破解了 [2]，NXP 公司只好宣布今后不再使用这张卡。</p><p>然而如今 2023 年，只需要1分钟左右就能完整破解的 M1 卡依旧风靡国内外，它的生命周期已经持续了近 30 年。</p><p>NXP 的 M1 卡算是密码学应用一个非常有意思的反面教材了，这篇文章会详细介绍 M1 卡的设计，以及是如何一步一步被破解的。</p><p>我会先介绍 NFC 破解相关的软硬件，接下来介绍 M1 卡的数据存储和认证加密方式 (Authentication &amp; Encryption)，最后介绍三种分别针对 UID, Authentication, Encryption (Crypto1) 的攻击方式。</p><h2 id="介绍：NFC-开源软硬件" style=""><a class="anchor hidden-xs" href="#介绍：NFC-开源软硬件" title="介绍：NFC-开源软硬件"><i class="fa fa-link"></i></a>介绍：NFC 开源软硬件</h2><p>如果只是希望迅速实践，破解手边的一张门禁卡，有 2 个选择：一是买一个 PN532 模块，配合 Github 的 mfoc 程序，一行命令，一分钟就能破解复制。</p><p><img src="" alt="img"></p><ul>
<li><a href="https://github.com/nfc-tools/mfoc-hardnested" target="_blank" rel="noopener">GitHub: mfoc-hardnested</a></li>
</ul><pre><code># pn532 + mfoc 破解命令
$ sudo mfoc-hardnested -O mycard.mfd
</code></pre><p>或者买一个 Proxmark 3，也能在一分钟左右迅速破解 M1 卡。</p><p><img src="" alt="img"></p><ul>
<li><a href="https://github.com/RfidResearchGroup/proxmark3" target="_blank" rel="noopener">GitHub: Proxmark3</a></li>
</ul><pre><code># Proxmark 破解命令
$ hf mf autopwn
</code></pre><p>具体的实践教程 GitHub 项目有文档，安装好软件后破解也就只需要上面一行命令，这里就不详细演示了，接下来主要介绍 M1 卡的 Authentication 和 Encryption 的设计，以及如何逆向工程还原内部设计和破解的。</p><h2 id="介绍：M1-卡数据存储" style=""><a class="anchor hidden-xs" href="#介绍：M1-卡数据存储" title="介绍：M1-卡数据存储"><i class="fa fa-link"></i></a>介绍：M1 卡数据存储</h2><p>首先介绍一下 M1 卡的设计，可以把它看作一个带 ID 的容量特别小的 U 盘（只有 1KB = 1024 Byte）。</p><p>如果作为门禁卡使用，1KB 存储房间信息足够了。除了存储之外，每张卡还有一个全球唯一的 ID，所以即使不存储房间信息，也可以光靠匹配这个 ID 进行认证。当然这是不安全的，然而曾经华科宿舍、图书馆的门禁系统也确实是这么不安全地设计的。</p><p>现在 M1 卡可以做得特别小，甚至可以像贴纸一样直接贴在手机背后。</p><p><img src="" alt="img"></p><p>如果我们看一下它的内部构造，其实就是一个线圈 + 芯片。当 NFC 卡接近读卡器的时候，读卡器就会通过线圈给卡片里的芯片供电，读取它的 ID 和数据。这里顺便一提，M1卡的工作频率是高频 13.56MHz，早期也有一些不带存储功能的卡，只能读全球唯一的 ID，那种卡的工作频率通常在低频 125KHz。</p><p><img src="" alt="img"></p><p>例如可以用 proxmark 的命令读取 M1 卡的 ID：</p><pre><code>$ hf search
</code></pre><p><img src="" alt="img"></p><p>可以看到这张卡的 UID  有 4 个字节： 0xDC 0x23 0xAB 0x11，同样我们也可以读取卡内 1K 的数据，当然卡内的数据是经过加密的，一共可以存储 1K = 1024 Byte。下面图上就是一张空卡的一个区块的数据 (64 Byte)：</p><p><img src="" alt="img"></p><p>例如，十六进制 FF 代表二进制 1111 (F) 1111 (F)， 一共有 8 位（bit），也就是 1 个 Byte。</p><p>上面这张图，一行有 16 个 FF，也就是 16 个 Byte。图上一共有 4 行，也就是 16 x 4 = 64 Byte。前面我们提到，一张 M1 卡有 1024 Byte  的存储空间，1024 = 16 * 64，所以可以推出来，一张卡有 16 个上面这张图的区块，下面就是一张完整的卡的数据：</p><p><img src="" alt="img"></p><p>如果你耐心地数一数，一共有 64 行，每行 16 Byte  刚好是 64 x 16 = 1024 Byte，也就是 M1 卡的全部 1KB 数据。</p><p>到这里介绍了 M1 卡有一个全球唯一的 UID 和 1KB  的存储数据，下面会介绍这 1KB 的数据是如何加密的。</p><h2 id="介绍：M1-卡数据加密" style=""><a class="anchor hidden-xs" href="#介绍：M1-卡数据加密" title="介绍：M1-卡数据加密"><i class="fa fa-link"></i></a>介绍：M1 卡数据加密</h2><p>M1 卡的 UID 是全球唯一，不可修改，不过没有经过加密，可以随意读取的，而 1KB 的数据则是经过加密的。虽然 M1 卡有全球唯一的 UID 和 1KB 的存储，但是也有不少应用为了图简单，并不读取卡内的数据，只是匹配卡的  UID 就通过门禁。</p><p>前面提到，1024 Byte 的数据分为 16 个区块，每个区块 64 个 Byte。这 16 个区块是分别加密的，也就是说可以分别为每个区块设置不同的密钥，M1 卡的密钥又分为 Key A 和 Key B。如果要完整读取一张卡的数据，需要知道全部的 16 组密钥。</p><p><img src="https://picx.zhimg.com/80/v2-a29d8f163871010f44c2accc68545e26_1440w.png?source=d16d100b" alt="img"></p><p>有意思的是，密钥是直接存储在对应的区块 (Block) 里的，比如上面图里的最后一行，就是这个区块的密钥。</p><p>最后一行有 16 Byte，前 6 个 Byte 是 Key A，后 6 个 Byte 是 Key B，中间的 4 个 Byte 的控制位，决定我们读写数据的权限。因此，这张默认白卡的 Key A 是前 6 个 Byte：FF FF FF FF FF FF，默认的 Key B 是后 6 个 Byte：FF FF FF FF FF FF。</p><p><img src="" alt="img"></p><blockquote>
<p>M1 卡完全破解需要 16 组 Key A 和 Key B</p>
</blockquote><p>我们可以设置控制位，例如有 Key A 的人只能读取数据，不能修改密钥；有 Key B 的人，既可以读取数据，也可以修改密钥。这里不详细介绍控制位，因为这是应用方面的设计，和加密机制无关。</p><p>M1 卡的加密机制分为两个部分，认证 (Authentication) 和 加密 (Encryption)。认证过程读卡器需要确定卡的型号，读取卡的 UID，选择要读取的扇区，以及交换信息用于后面的加密。</p><h3 id="1-Authentication" style=""><a class="anchor hidden-xs" href="#1-Authentication" title="1-Authentication"><i class="fa fa-link"></i></a>1. Authentication</h3><p>不过这个认证过程并不是 NXP 公司特有的，而是遵循 ISO14443-A 的规范。然而 M1 卡并没有完全遵循这个规范，也因此有了一些设计上的漏洞。</p><p>例如下面的通讯流程，<strong>我们用 Tag (T) 表示 NFC 卡，用 Reader ® 表示读卡器</strong>。上电后先执行一些非加密通讯：例如读 UID，选择要读取的 Block。为了进行加密通讯，Tag 会先发送一个 Nonce 用 <span class="mathjax"><span class="MathJax_Preview" style="color: inherit;"></span><span class="MathJax" id="MathJax-Element-1-Frame" tabindex="0" style="position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>n</mi><mi>T</mi></msub></math>" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-1" style="width: 1.404em; display: inline-block;"><span style="display: inline-block; position: relative; width: 1.188em; height: 0px; font-size: 116%;"><span style="position: absolute; clip: rect(1.781em, 1001.19em, 2.697em, -999.997em); top: -2.368em; left: 0em;"><span class="mrow" id="MathJax-Span-2"><span class="msubsup" id="MathJax-Span-3"><span style="display: inline-block; position: relative; width: 1.188em; height: 0px;"><span style="position: absolute; clip: rect(3.397em, 1000.6em, 4.151em, -999.997em); top: -3.984em; left: 0em;"><span class="mi" id="MathJax-Span-4" style="font-family: MathJax_Math-italic;">n</span><span style="display: inline-block; width: 0px; height: 3.99em;"></span></span><span style="position: absolute; top: -3.823em; left: 0.595em;"><span class="mi" id="MathJax-Span-5" style="font-size: 70.7%; font-family: MathJax_Math-italic;">T<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.11em;"></span></span><span style="display: inline-block; width: 0px; height: 3.99em;"></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 2.373em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 0.816em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><msub><mi>n</mi><mi>T</mi></msub></math></span></span><script type="math/tex" id="MathJax-Element-1">n_T</script></span> 表示，Reader 收到来自 NFC 卡的 <span class="mathjax"><span class="MathJax_Preview" style="color: inherit;"></span><span class="MathJax" id="MathJax-Element-2-Frame" tabindex="0" style="position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>n</mi><mi>T</mi></msub></math>" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-6" style="width: 1.404em; display: inline-block;"><span style="display: inline-block; position: relative; width: 1.188em; height: 0px; font-size: 116%;"><span style="position: absolute; clip: rect(1.781em, 1001.19em, 2.697em, -999.997em); top: -2.368em; left: 0em;"><span class="mrow" id="MathJax-Span-7"><span class="msubsup" id="MathJax-Span-8"><span style="display: inline-block; position: relative; width: 1.188em; height: 0px;"><span style="position: absolute; clip: rect(3.397em, 1000.6em, 4.151em, -999.997em); top: -3.984em; left: 0em;"><span class="mi" id="MathJax-Span-9" style="font-family: MathJax_Math-italic;">n</span><span style="display: inline-block; width: 0px; height: 3.99em;"></span></span><span style="position: absolute; top: -3.823em; left: 0.595em;"><span class="mi" id="MathJax-Span-10" style="font-size: 70.7%; font-family: MathJax_Math-italic;">T<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.11em;"></span></span><span style="display: inline-block; width: 0px; height: 3.99em;"></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 2.373em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 0.816em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><msub><mi>n</mi><mi>T</mi></msub></math></span></span><script type="math/tex" id="MathJax-Element-2">n_T</script></span> 之后，会发送自己的响应 <span class="mathjax"><span class="MathJax_Preview" style="color: inherit;"></span><span class="MathJax" id="MathJax-Element-3-Frame" tabindex="0" style="position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>a</mi><mi>R</mi></msub></math>" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-11" style="width: 1.35em; display: inline-block;"><span style="display: inline-block; position: relative; width: 1.134em; height: 0px; font-size: 116%;"><span style="position: absolute; clip: rect(1.781em, 1001.13em, 2.697em, -999.997em); top: -2.368em; left: 0em;"><span class="mrow" id="MathJax-Span-12"><span class="msubsup" id="MathJax-Span-13"><span style="display: inline-block; position: relative; width: 1.134em; height: 0px;"><span style="position: absolute; clip: rect(3.397em, 1000.49em, 4.151em, -999.997em); top: -3.984em; left: 0em;"><span class="mi" id="MathJax-Span-14" style="font-family: MathJax_Math-italic;">a</span><span style="display: inline-block; width: 0px; height: 3.99em;"></span></span><span style="position: absolute; top: -3.823em; left: 0.541em;"><span class="mi" id="MathJax-Span-15" style="font-size: 70.7%; font-family: MathJax_Math-italic;">R</span><span style="display: inline-block; width: 0px; height: 3.99em;"></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 2.373em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 0.816em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><msub><mi>a</mi><mi>R</mi></msub></math></span></span><script type="math/tex" id="MathJax-Element-3">a_R</script></span> 来表明自己是合法的读卡器。同时，读卡器也会发送自己的 Nonce  用 <span class="mathjax"><span class="MathJax_Preview" style="color: inherit;"></span><span class="MathJax" id="MathJax-Element-4-Frame" tabindex="0" style="position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>n</mi><mi>R</mi></msub></math>" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-16" style="width: 1.404em; display: inline-block;"><span style="display: inline-block; position: relative; width: 1.188em; height: 0px; font-size: 116%;"><span style="position: absolute; clip: rect(1.781em, 1001.19em, 2.697em, -999.997em); top: -2.368em; left: 0em;"><span class="mrow" id="MathJax-Span-17"><span class="msubsup" id="MathJax-Span-18"><span style="display: inline-block; position: relative; width: 1.188em; height: 0px;"><span style="position: absolute; clip: rect(3.397em, 1000.6em, 4.151em, -999.997em); top: -3.984em; left: 0em;"><span class="mi" id="MathJax-Span-19" style="font-family: MathJax_Math-italic;">n</span><span style="display: inline-block; width: 0px; height: 3.99em;"></span></span><span style="position: absolute; top: -3.823em; left: 0.595em;"><span class="mi" id="MathJax-Span-20" style="font-size: 70.7%; font-family: MathJax_Math-italic;">R</span><span style="display: inline-block; width: 0px; height: 3.99em;"></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 2.373em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 0.816em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><msub><mi>n</mi><mi>R</mi></msub></math></span></span><script type="math/tex" id="MathJax-Element-4">n_R</script></span> 表示，在收到 NFC 卡的合法相应 <span class="mathjax"><span class="MathJax_Preview" style="color: inherit;"></span><span class="MathJax" id="MathJax-Element-5-Frame" tabindex="0" style="position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>a</mi><mi>T</mi></msub></math>" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-21" style="width: 1.242em; display: inline-block;"><span style="display: inline-block; position: relative; width: 1.08em; height: 0px; font-size: 116%;"><span style="position: absolute; clip: rect(1.781em, 1001.08em, 2.697em, -999.997em); top: -2.368em; left: 0em;"><span class="mrow" id="MathJax-Span-22"><span class="msubsup" id="MathJax-Span-23"><span style="display: inline-block; position: relative; width: 1.08em; height: 0px;"><span style="position: absolute; clip: rect(3.397em, 1000.49em, 4.151em, -999.997em); top: -3.984em; left: 0em;"><span class="mi" id="MathJax-Span-24" style="font-family: MathJax_Math-italic;">a</span><span style="display: inline-block; width: 0px; height: 3.99em;"></span></span><span style="position: absolute; top: -3.823em; left: 0.541em;"><span class="mi" id="MathJax-Span-25" style="font-size: 70.7%; font-family: MathJax_Math-italic;">T<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.11em;"></span></span><span style="display: inline-block; width: 0px; height: 3.99em;"></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 2.373em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 0.816em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><msub><mi>a</mi><mi>T</mi></msub></math></span></span><script type="math/tex" id="MathJax-Element-5">a_T</script></span> 之后，就互相验明身份，愉快地开始加密通讯了。</p><p>简而言之，NFC 卡发送 <span class="mathjax"><span class="MathJax_Preview" style="color: inherit;"></span><span class="MathJax" id="MathJax-Element-6-Frame" tabindex="0" style="position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>n</mi><mi>T</mi></msub></math>" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-26" style="width: 1.404em; display: inline-block;"><span style="display: inline-block; position: relative; width: 1.188em; height: 0px; font-size: 116%;"><span style="position: absolute; clip: rect(1.781em, 1001.19em, 2.697em, -999.997em); top: -2.368em; left: 0em;"><span class="mrow" id="MathJax-Span-27"><span class="msubsup" id="MathJax-Span-28"><span style="display: inline-block; position: relative; width: 1.188em; height: 0px;"><span style="position: absolute; clip: rect(3.397em, 1000.6em, 4.151em, -999.997em); top: -3.984em; left: 0em;"><span class="mi" id="MathJax-Span-29" style="font-family: MathJax_Math-italic;">n</span><span style="display: inline-block; width: 0px; height: 3.99em;"></span></span><span style="position: absolute; top: -3.823em; left: 0.595em;"><span class="mi" id="MathJax-Span-30" style="font-size: 70.7%; font-family: MathJax_Math-italic;">T<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.11em;"></span></span><span style="display: inline-block; width: 0px; height: 3.99em;"></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 2.373em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 0.816em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><msub><mi>n</mi><mi>T</mi></msub></math></span></span><script type="math/tex" id="MathJax-Element-6">n_T</script></span> 收到 <span class="mathjax"><span class="MathJax_Preview" style="color: inherit;"></span><span class="MathJax" id="MathJax-Element-7-Frame" tabindex="0" style="position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>a</mi><mi>R</mi></msub></math>" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-31" style="width: 1.35em; display: inline-block;"><span style="display: inline-block; position: relative; width: 1.134em; height: 0px; font-size: 116%;"><span style="position: absolute; clip: rect(1.781em, 1001.13em, 2.697em, -999.997em); top: -2.368em; left: 0em;"><span class="mrow" id="MathJax-Span-32"><span class="msubsup" id="MathJax-Span-33"><span style="display: inline-block; position: relative; width: 1.134em; height: 0px;"><span style="position: absolute; clip: rect(3.397em, 1000.49em, 4.151em, -999.997em); top: -3.984em; left: 0em;"><span class="mi" id="MathJax-Span-34" style="font-family: MathJax_Math-italic;">a</span><span style="display: inline-block; width: 0px; height: 3.99em;"></span></span><span style="position: absolute; top: -3.823em; left: 0.541em;"><span class="mi" id="MathJax-Span-35" style="font-size: 70.7%; font-family: MathJax_Math-italic;">R</span><span style="display: inline-block; width: 0px; height: 3.99em;"></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 2.373em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 0.816em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><msub><mi>a</mi><mi>R</mi></msub></math></span></span><script type="math/tex" id="MathJax-Element-7">a_R</script></span> ，读卡器发送 <span class="mathjax"><span class="MathJax_Preview" style="color: inherit;"></span><span class="MathJax" id="MathJax-Element-8-Frame" tabindex="0" style="position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>n</mi><mi>R</mi></msub></math>" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-36" style="width: 1.404em; display: inline-block;"><span style="display: inline-block; position: relative; width: 1.188em; height: 0px; font-size: 116%;"><span style="position: absolute; clip: rect(1.781em, 1001.19em, 2.697em, -999.997em); top: -2.368em; left: 0em;"><span class="mrow" id="MathJax-Span-37"><span class="msubsup" id="MathJax-Span-38"><span style="display: inline-block; position: relative; width: 1.188em; height: 0px;"><span style="position: absolute; clip: rect(3.397em, 1000.6em, 4.151em, -999.997em); top: -3.984em; left: 0em;"><span class="mi" id="MathJax-Span-39" style="font-family: MathJax_Math-italic;">n</span><span style="display: inline-block; width: 0px; height: 3.99em;"></span></span><span style="position: absolute; top: -3.823em; left: 0.595em;"><span class="mi" id="MathJax-Span-40" style="font-size: 70.7%; font-family: MathJax_Math-italic;">R</span><span style="display: inline-block; width: 0px; height: 3.99em;"></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 2.373em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 0.816em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><msub><mi>n</mi><mi>R</mi></msub></math></span></span><script type="math/tex" id="MathJax-Element-8">n_R</script></span> 收到 <span class="mathjax"><span class="MathJax_Preview" style="color: inherit;"></span><span class="MathJax" id="MathJax-Element-9-Frame" tabindex="0" style="position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>a</mi><mi>T</mi></msub></math>" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-41" style="width: 1.242em; display: inline-block;"><span style="display: inline-block; position: relative; width: 1.08em; height: 0px; font-size: 116%;"><span style="position: absolute; clip: rect(1.781em, 1001.08em, 2.697em, -999.997em); top: -2.368em; left: 0em;"><span class="mrow" id="MathJax-Span-42"><span class="msubsup" id="MathJax-Span-43"><span style="display: inline-block; position: relative; width: 1.08em; height: 0px;"><span style="position: absolute; clip: rect(3.397em, 1000.49em, 4.151em, -999.997em); top: -3.984em; left: 0em;"><span class="mi" id="MathJax-Span-44" style="font-family: MathJax_Math-italic;">a</span><span style="display: inline-block; width: 0px; height: 3.99em;"></span></span><span style="position: absolute; top: -3.823em; left: 0.541em;"><span class="mi" id="MathJax-Span-45" style="font-size: 70.7%; font-family: MathJax_Math-italic;">T<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.11em;"></span></span><span style="display: inline-block; width: 0px; height: 3.99em;"></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 2.373em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 0.816em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><msub><mi>a</mi><mi>T</mi></msub></math></span></span><script type="math/tex" id="MathJax-Element-9">a_T</script></span>，互验身份。</p><p><img src="" alt="img"></p><h3 id="2-Encryption" style=""><a class="anchor hidden-xs" href="#2-Encryption" title="2-Encryption"><i class="fa fa-link"></i></a>2. Encryption</h3><p>前面提到，M1 卡的加密算法 Crypto1 是不对外公开的，后面被逆向工程破解后公开的。</p><p>之前一篇密码学的文章提到，加密分为 <strong>对称加密</strong> 和 <strong>非对称加密</strong>，对于轻量级的嵌入式应用，并没有足够的算力跑非对称加密，所以都是用 <strong>对称加密</strong> 加密实际的数据，<strong>非对称加密</strong> 则是用来生成密钥对。</p><p>M1 卡则是出场默认密钥 Key A 和 Key B，后面也可以用默认的密钥修改 Key A 和 Key B，所以 M1 卡的加密过程不需要在芯片上生成密钥，直接使用 Crypto1 加密就可以了。对称加密 分为 <strong>块加密 (Block Cipher)</strong> 和 <strong>流加密 (Stream Cipher)</strong>，而 Crypto1 属于 流加密 (Stream Cipher)。</p><p>我们弄清 M1 卡分为 Authentication 和 Encryption 两部分之后，接下来介绍 M1 卡是怎样被逆向工程破解的。</p><h2 id="破解1：UID-复制" style=""><a class="anchor hidden-xs" href="#破解1：UID-复制" title="破解1：UID-复制"><i class="fa fa-link"></i></a>破解1：UID 复制</h2><p>首先，最简单的破解是 UID 的复制。之前介绍过，虽然 M1 卡有全球唯一的 UID 和 1KB 的存储，但是也有不少应用为了图简单，并不读取卡内的数据，只是匹配卡的  UID 就通过门禁。</p><p>正常情况下，按照规矩，M1 卡的 UID 是出厂的时候就固化的，不能进行修改。但是不知道什么时候起，万能的中国厂商在生产某些 M1 卡的时候，留了后门，可以通过后门程序非法修改 UID。这也就意味着可以克隆一张 M1 卡的 UID 了，如果门禁系统又恰好只认证 UID，那么我们就可以非法通过了。</p><p>下面是用 Proxmark 检测一张 M1 卡是不是留有中国特色后门，这种留有后门的卡称之为 Magic Card：</p><pre><code>$ hf search
</code></pre><p><img src="" alt="img"></p><p>当然，并不是所有中国生产的 M1 卡都留有后门的，需要专门买可以修改 UID 的卡，最早不知道 M1 卡内部的加密算法的时候，就是通过中国特色后门来复制 UID 破解门禁的。</p><h2 id="破解2：Authentication" style=""><a class="anchor hidden-xs" href="#破解2：Authentication" title="破解2：Authentication"><i class="fa fa-link"></i></a>破解2：Authentication</h2><p>由于 NXP 并没有公开算法细节，最开始破解只能通过 FPGA 抓包的形式，分析可能的内部设计。不过也不是一无所知，加密算法的设计也是有标准的，例如高效的硬件加密通常会用 LFSR 组合生成 Keystream。</p><p>2015  年，Garcia et al. 通过监听数据包，完全复原了 Crypto1 的设计，为此 NXP 还将论文作者告上了法庭，阻止这篇论文的发表 [1]。当然，最后论文还是顺利发表了。</p><p>为了复原 Authentication 的流程，我们需要用 Proxmark 模拟一个 M1 NFC 卡，和读卡器进行通讯。因为是 Proxmark 模拟的 NFC 卡，我们可以随意控制卡的 ID 以及通讯流程。Authentication 的目的是为了让 NFC 卡和读卡器能互相验证身份，同步初始化加密模块的状态，这样就可以生成相同的 keystream 用于通信（如果这里不清楚，可以回顾一下 Stream Cipher）。</p><p>这里再重复说明一下认证流程：<strong>我们用 Tag (T) 表示 NFC 卡，用 Reader ® 表示读卡器</strong>。上电后先执行一些非加密通讯：例如读 UID，选择要读取的 Block。为了进行加密通讯，NFC 卡发送 <span class="mathjax"><span class="MathJax_Preview" style="color: inherit;"></span><span class="MathJax" id="MathJax-Element-63-Frame" tabindex="0" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>n</mi><mi>T</mi></msub></math>" role="presentation" style="position: relative;"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-445" style="width: 1.404em; display: inline-block;"><span style="display: inline-block; position: relative; width: 1.188em; height: 0px; font-size: 116%;"><span style="position: absolute; clip: rect(1.781em, 1001.19em, 2.697em, -999.997em); top: -2.368em; left: 0em;"><span class="mrow" id="MathJax-Span-446"><span class="msubsup" id="MathJax-Span-447"><span style="display: inline-block; position: relative; width: 1.188em; height: 0px;"><span style="position: absolute; clip: rect(3.397em, 1000.6em, 4.151em, -999.997em); top: -3.984em; left: 0em;"><span class="mi" id="MathJax-Span-448" style="font-family: MathJax_Math-italic;">n</span><span style="display: inline-block; width: 0px; height: 3.99em;"></span></span><span style="position: absolute; top: -3.823em; left: 0.595em;"><span class="mi" id="MathJax-Span-449" style="font-size: 70.7%; font-family: MathJax_Math-italic;">T<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.11em;"></span></span><span style="display: inline-block; width: 0px; height: 3.99em;"></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 2.373em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 0.816em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><msub><mi>n</mi><mi>T</mi></msub></math></span></span><script type="math/tex" id="MathJax-Element-63">n_T</script></span> 收到 <span class="mathjax"><span class="MathJax_Preview" style="color: inherit;"></span><span class="MathJax" id="MathJax-Element-64-Frame" tabindex="0" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>a</mi><mi>R</mi></msub></math>" role="presentation" style="position: relative;"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-450" style="width: 1.35em; display: inline-block;"><span style="display: inline-block; position: relative; width: 1.134em; height: 0px; font-size: 116%;"><span style="position: absolute; clip: rect(1.781em, 1001.13em, 2.697em, -999.997em); top: -2.368em; left: 0em;"><span class="mrow" id="MathJax-Span-451"><span class="msubsup" id="MathJax-Span-452"><span style="display: inline-block; position: relative; width: 1.134em; height: 0px;"><span style="position: absolute; clip: rect(3.397em, 1000.49em, 4.151em, -999.997em); top: -3.984em; left: 0em;"><span class="mi" id="MathJax-Span-453" style="font-family: MathJax_Math-italic;">a</span><span style="display: inline-block; width: 0px; height: 3.99em;"></span></span><span style="position: absolute; top: -3.823em; left: 0.541em;"><span class="mi" id="MathJax-Span-454" style="font-size: 70.7%; font-family: MathJax_Math-italic;">R</span><span style="display: inline-block; width: 0px; height: 3.99em;"></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 2.373em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 0.816em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><msub><mi>a</mi><mi>R</mi></msub></math></span></span><script type="math/tex" id="MathJax-Element-64">a_R</script></span>，读卡器发送 <span class="mathjax"><span class="MathJax_Preview" style="color: inherit;"></span><span class="MathJax" id="MathJax-Element-65-Frame" tabindex="0" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>n</mi><mi>R</mi></msub></math>" role="presentation" style="position: relative;"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-455" style="width: 1.404em; display: inline-block;"><span style="display: inline-block; position: relative; width: 1.188em; height: 0px; font-size: 116%;"><span style="position: absolute; clip: rect(1.781em, 1001.19em, 2.697em, -999.997em); top: -2.368em; left: 0em;"><span class="mrow" id="MathJax-Span-456"><span class="msubsup" id="MathJax-Span-457"><span style="display: inline-block; position: relative; width: 1.188em; height: 0px;"><span style="position: absolute; clip: rect(3.397em, 1000.6em, 4.151em, -999.997em); top: -3.984em; left: 0em;"><span class="mi" id="MathJax-Span-458" style="font-family: MathJax_Math-italic;">n</span><span style="display: inline-block; width: 0px; height: 3.99em;"></span></span><span style="position: absolute; top: -3.823em; left: 0.595em;"><span class="mi" id="MathJax-Span-459" style="font-size: 70.7%; font-family: MathJax_Math-italic;">R</span><span style="display: inline-block; width: 0px; height: 3.99em;"></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 2.373em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 0.816em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><msub><mi>n</mi><mi>R</mi></msub></math></span></span><script type="math/tex" id="MathJax-Element-65">n_R</script></span> 收到 <span class="mathjax"><span class="MathJax_Preview" style="color: inherit;"></span><span class="MathJax" id="MathJax-Element-66-Frame" tabindex="0" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>a</mi><mi>T</mi></msub></math>" role="presentation" style="position: relative;"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-460" style="width: 1.242em; display: inline-block;"><span style="display: inline-block; position: relative; width: 1.08em; height: 0px; font-size: 116%;"><span style="position: absolute; clip: rect(1.781em, 1001.08em, 2.697em, -999.997em); top: -2.368em; left: 0em;"><span class="mrow" id="MathJax-Span-461"><span class="msubsup" id="MathJax-Span-462"><span style="display: inline-block; position: relative; width: 1.08em; height: 0px;"><span style="position: absolute; clip: rect(3.397em, 1000.49em, 4.151em, -999.997em); top: -3.984em; left: 0em;"><span class="mi" id="MathJax-Span-463" style="font-family: MathJax_Math-italic;">a</span><span style="display: inline-block; width: 0px; height: 3.99em;"></span></span><span style="position: absolute; top: -3.823em; left: 0.541em;"><span class="mi" id="MathJax-Span-464" style="font-size: 70.7%; font-family: MathJax_Math-italic;">T<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.11em;"></span></span><span style="display: inline-block; width: 0px; height: 3.99em;"></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 2.373em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 0.816em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><msub><mi>a</mi><mi>T</mi></msub></math></span></span><script type="math/tex" id="MathJax-Element-66">a_T</script></span>，互验身份。</p><p><img src="https://pica.zhimg.com/80/v2-82002121129896b2a3a4dbc7be4cbec2_1440w.png?source=d16d100b" alt="img"></p><p>这个认证过程的漏洞在于，NFC 卡 PRNG (伪随机数发生器) 生成的 Nonce 是可以预测的，每次上电后只要经过的时间相同， 生成的 <span class="mathjax"><span class="MathJax_Preview" style="color: inherit;"></span><span class="MathJax" id="MathJax-Element-14-Frame" tabindex="0" style="position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>n</mi><mi>T</mi></msub></math>" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-66" style="width: 1.404em; display: inline-block;"><span style="display: inline-block; position: relative; width: 1.188em; height: 0px; font-size: 116%;"><span style="position: absolute; clip: rect(1.781em, 1001.19em, 2.697em, -999.997em); top: -2.368em; left: 0em;"><span class="mrow" id="MathJax-Span-67"><span class="msubsup" id="MathJax-Span-68"><span style="display: inline-block; position: relative; width: 1.188em; height: 0px;"><span style="position: absolute; clip: rect(3.397em, 1000.6em, 4.151em, -999.997em); top: -3.984em; left: 0em;"><span class="mi" id="MathJax-Span-69" style="font-family: MathJax_Math-italic;">n</span><span style="display: inline-block; width: 0px; height: 3.99em;"></span></span><span style="position: absolute; top: -3.823em; left: 0.595em;"><span class="mi" id="MathJax-Span-70" style="font-size: 70.7%; font-family: MathJax_Math-italic;">T<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.11em;"></span></span><span style="display: inline-block; width: 0px; height: 3.99em;"></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 2.373em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 0.816em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><msub><mi>n</mi><mi>T</mi></msub></math></span></span><script type="math/tex" id="MathJax-Element-14">n_T</script></span> 都是固定的。于是我们就可以修改模拟卡的 UID，反复生成相同的 <span class="mathjax"><span class="MathJax_Preview" style="color: inherit;"></span><span class="MathJax" id="MathJax-Element-15-Frame" tabindex="0" style="position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>n</mi><mi>T</mi></msub></math>" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-71" style="width: 1.404em; display: inline-block;"><span style="display: inline-block; position: relative; width: 1.188em; height: 0px; font-size: 116%;"><span style="position: absolute; clip: rect(1.781em, 1001.19em, 2.697em, -999.997em); top: -2.368em; left: 0em;"><span class="mrow" id="MathJax-Span-72"><span class="msubsup" id="MathJax-Span-73"><span style="display: inline-block; position: relative; width: 1.188em; height: 0px;"><span style="position: absolute; clip: rect(3.397em, 1000.6em, 4.151em, -999.997em); top: -3.984em; left: 0em;"><span class="mi" id="MathJax-Span-74" style="font-family: MathJax_Math-italic;">n</span><span style="display: inline-block; width: 0px; height: 3.99em;"></span></span><span style="position: absolute; top: -3.823em; left: 0.595em;"><span class="mi" id="MathJax-Span-75" style="font-size: 70.7%; font-family: MathJax_Math-italic;">T<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.11em;"></span></span><span style="display: inline-block; width: 0px; height: 3.99em;"></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 2.373em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 0.816em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><msub><mi>n</mi><mi>T</mi></msub></math></span></span><script type="math/tex" id="MathJax-Element-15">n_T</script></span> 来看读卡器的反应，并且 Garcia 发现，只要 <span class="mathjax"><span class="MathJax_Preview" style="color: inherit;"></span><span class="MathJax" id="MathJax-Element-16-Frame" tabindex="0" style="position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>n</mi><mi>T</mi></msub><mo>&amp;#x2295;</mo><mi>u</mi><mi>i</mi><mi>d</mi></math>" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-76" style="width: 4.475em; display: inline-block;"><span style="display: inline-block; position: relative; width: 3.828em; height: 0px; font-size: 116%;"><span style="position: absolute; clip: rect(1.511em, 1003.83em, 2.697em, -999.997em); top: -2.368em; left: 0em;"><span class="mrow" id="MathJax-Span-77"><span class="msubsup" id="MathJax-Span-78"><span style="display: inline-block; position: relative; width: 1.188em; height: 0px;"><span style="position: absolute; clip: rect(3.397em, 1000.6em, 4.151em, -999.997em); top: -3.984em; left: 0em;"><span class="mi" id="MathJax-Span-79" style="font-family: MathJax_Math-italic;">n</span><span style="display: inline-block; width: 0px; height: 3.99em;"></span></span><span style="position: absolute; top: -3.823em; left: 0.595em;"><span class="mi" id="MathJax-Span-80" style="font-size: 70.7%; font-family: MathJax_Math-italic;">T<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.11em;"></span></span><span style="display: inline-block; width: 0px; height: 3.99em;"></span></span></span></span><span class="mo" id="MathJax-Span-81" style="font-family: MathJax_Main; padding-left: 0.218em;">⊕</span><span class="mi" id="MathJax-Span-82" style="font-family: MathJax_Math-italic; padding-left: 0.218em;">u</span><span class="mi" id="MathJax-Span-83" style="font-family: MathJax_Math-italic;">i</span><span class="mi" id="MathJax-Span-84" style="font-family: MathJax_Math-italic;">d<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.003em;"></span></span></span><span style="display: inline-block; width: 0px; height: 2.373em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.128em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><msub><mi>n</mi><mi>T</mi></msub><mo>⊕</mo><mi>u</mi><mi>i</mi><mi>d</mi></math></span></span><script type="math/tex" id="MathJax-Element-16">n_T  \oplus uid</script></span> 的值相同，图上 09 行读卡器加密后的相应 <span class="mathjax"><span class="MathJax_Preview" style="color: inherit;"></span><span class="MathJax" id="MathJax-Element-17-Frame" tabindex="0" style="position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>n</mi><mi>R</mi></msub><mo>&amp;#x2295;</mo><mi>k</mi><msub><mi>s</mi><mn>1</mn></msub></math>" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-85" style="width: 4.475em; display: inline-block;"><span style="display: inline-block; position: relative; width: 3.828em; height: 0px; font-size: 116%;"><span style="position: absolute; clip: rect(1.511em, 1003.83em, 2.697em, -999.997em); top: -2.368em; left: 0em;"><span class="mrow" id="MathJax-Span-86"><span class="msubsup" id="MathJax-Span-87"><span style="display: inline-block; position: relative; width: 1.188em; height: 0px;"><span style="position: absolute; clip: rect(3.397em, 1000.6em, 4.151em, -999.997em); top: -3.984em; left: 0em;"><span class="mi" id="MathJax-Span-88" style="font-family: MathJax_Math-italic;">n</span><span style="display: inline-block; width: 0px; height: 3.99em;"></span></span><span style="position: absolute; top: -3.823em; left: 0.595em;"><span class="mi" id="MathJax-Span-89" style="font-size: 70.7%; font-family: MathJax_Math-italic;">R</span><span style="display: inline-block; width: 0px; height: 3.99em;"></span></span></span></span><span class="mo" id="MathJax-Span-90" style="font-family: MathJax_Main; padding-left: 0.218em;">⊕</span><span class="mi" id="MathJax-Span-91" style="font-family: MathJax_Math-italic; padding-left: 0.218em;">k</span><span class="msubsup" id="MathJax-Span-92"><span style="display: inline-block; position: relative; width: 0.919em; height: 0px;"><span style="position: absolute; clip: rect(3.397em, 1000.43em, 4.151em, -999.997em); top: -3.984em; left: 0em;"><span class="mi" id="MathJax-Span-93" style="font-family: MathJax_Math-italic;">s</span><span style="display: inline-block; width: 0px; height: 3.99em;"></span></span><span style="position: absolute; top: -3.823em; left: 0.488em;"><span class="mn" id="MathJax-Span-94" style="font-size: 70.7%; font-family: MathJax_Main;">1</span><span style="display: inline-block; width: 0px; height: 3.99em;"></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 2.373em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.128em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><msub><mi>n</mi><mi>R</mi></msub><mo>⊕</mo><mi>k</mi><msub><mi>s</mi><mn>1</mn></msub></math></span></span><script type="math/tex" id="MathJax-Element-17">n_R\oplus ks_1</script></span> 就是固定的。</p><p>前面提到，我们可以通过控制上电的时间，让每次生成相同的 <span class="mathjax"><span class="MathJax_Preview" style="color: inherit;"></span><span class="MathJax" id="MathJax-Element-18-Frame" tabindex="0" style="position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>n</mi><mi>T</mi></msub><mo>&amp;#x2295;</mo><mi>u</mi><mi>i</mi><mi>d</mi></math>" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-95" style="width: 4.475em; display: inline-block;"><span style="display: inline-block; position: relative; width: 3.828em; height: 0px; font-size: 116%;"><span style="position: absolute; clip: rect(1.511em, 1003.83em, 2.697em, -999.997em); top: -2.368em; left: 0em;"><span class="mrow" id="MathJax-Span-96"><span class="msubsup" id="MathJax-Span-97"><span style="display: inline-block; position: relative; width: 1.188em; height: 0px;"><span style="position: absolute; clip: rect(3.397em, 1000.6em, 4.151em, -999.997em); top: -3.984em; left: 0em;"><span class="mi" id="MathJax-Span-98" style="font-family: MathJax_Math-italic;">n</span><span style="display: inline-block; width: 0px; height: 3.99em;"></span></span><span style="position: absolute; top: -3.823em; left: 0.595em;"><span class="mi" id="MathJax-Span-99" style="font-size: 70.7%; font-family: MathJax_Math-italic;">T<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.11em;"></span></span><span style="display: inline-block; width: 0px; height: 3.99em;"></span></span></span></span><span class="mo" id="MathJax-Span-100" style="font-family: MathJax_Main; padding-left: 0.218em;">⊕</span><span class="mi" id="MathJax-Span-101" style="font-family: MathJax_Math-italic; padding-left: 0.218em;">u</span><span class="mi" id="MathJax-Span-102" style="font-family: MathJax_Math-italic;">i</span><span class="mi" id="MathJax-Span-103" style="font-family: MathJax_Math-italic;">d<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.003em;"></span></span></span><span style="display: inline-block; width: 0px; height: 2.373em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.128em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><msub><mi>n</mi><mi>T</mi></msub><mo>⊕</mo><mi>u</mi><mi>i</mi><mi>d</mi></math></span></span><script type="math/tex" id="MathJax-Element-18">n_T  \oplus uid</script></span> 和 keystream，例如图上第10行，我们从读卡器得到了2个不同的加密响应 <span class="mathjax"><span class="MathJax_Preview" style="color: inherit;"></span><span class="MathJax" id="MathJax-Element-19-Frame" tabindex="0" style="position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>a</mi><mi>T</mi></msub><mo>&amp;#x2295;</mo><mi>k</mi><msub><mi>s</mi><mn>3</mn></msub></math>" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-104" style="width: 4.313em; display: inline-block;"><span style="display: inline-block; position: relative; width: 3.72em; height: 0px; font-size: 116%;"><span style="position: absolute; clip: rect(1.511em, 1003.72em, 2.697em, -999.997em); top: -2.368em; left: 0em;"><span class="mrow" id="MathJax-Span-105"><span class="msubsup" id="MathJax-Span-106"><span style="display: inline-block; position: relative; width: 1.08em; height: 0px;"><span style="position: absolute; clip: rect(3.397em, 1000.49em, 4.151em, -999.997em); top: -3.984em; left: 0em;"><span class="mi" id="MathJax-Span-107" style="font-family: MathJax_Math-italic;">a</span><span style="display: inline-block; width: 0px; height: 3.99em;"></span></span><span style="position: absolute; top: -3.823em; left: 0.541em;"><span class="mi" id="MathJax-Span-108" style="font-size: 70.7%; font-family: MathJax_Math-italic;">T<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.11em;"></span></span><span style="display: inline-block; width: 0px; height: 3.99em;"></span></span></span></span><span class="mo" id="MathJax-Span-109" style="font-family: MathJax_Main; padding-left: 0.218em;">⊕</span><span class="mi" id="MathJax-Span-110" style="font-family: MathJax_Math-italic; padding-left: 0.218em;">k</span><span class="msubsup" id="MathJax-Span-111"><span style="display: inline-block; position: relative; width: 0.919em; height: 0px;"><span style="position: absolute; clip: rect(3.397em, 1000.43em, 4.151em, -999.997em); top: -3.984em; left: 0em;"><span class="mi" id="MathJax-Span-112" style="font-family: MathJax_Math-italic;">s</span><span style="display: inline-block; width: 0px; height: 3.99em;"></span></span><span style="position: absolute; top: -3.823em; left: 0.488em;"><span class="mn" id="MathJax-Span-113" style="font-size: 70.7%; font-family: MathJax_Main;">3</span><span style="display: inline-block; width: 0px; height: 3.99em;"></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 2.373em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.128em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><msub><mi>a</mi><mi>T</mi></msub><mo>⊕</mo><mi>k</mi><msub><mi>s</mi><mn>3</mn></msub></math></span></span><script type="math/tex" id="MathJax-Element-19">a_T \oplus ks_3</script></span> 和 <span class="mathjax"><span class="MathJax_Preview" style="color: inherit;"></span><span class="MathJax" id="MathJax-Element-20-Frame" tabindex="0" style="position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msubsup><mi>a</mi><mi>T</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><msup><mi></mi><mo>&amp;#x2032;</mo></msup></mrow></msubsup><mo>&amp;#x2295;</mo><mi>k</mi><msub><mi>s</mi><mn>3</mn></msub></math>" role="presentation"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-114" style="width: 4.313em; display: inline-block;"><span style="display: inline-block; position: relative; width: 3.72em; height: 0px; font-size: 116%;"><span style="position: absolute; clip: rect(1.35em, 1003.72em, 2.858em, -999.997em); top: -2.368em; left: 0em;"><span class="mrow" id="MathJax-Span-115"><span class="msubsup" id="MathJax-Span-116"><span style="display: inline-block; position: relative; width: 1.08em; height: 0px;"><span style="position: absolute; clip: rect(3.397em, 1000.49em, 4.151em, -999.997em); top: -3.984em; left: 0em;"><span class="mi" id="MathJax-Span-117" style="font-family: MathJax_Math-italic;">a</span><span style="display: inline-block; width: 0px; height: 3.99em;"></span></span><span style="position: absolute; clip: rect(3.289em, 1000.27em, 4.151em, -999.997em); top: -4.308em; left: 0.541em;"><span class="texatom" id="MathJax-Span-118"><span class="mrow" id="MathJax-Span-119"><span class="msup" id="MathJax-Span-120"><span style="display: inline-block; position: relative; width: 0.218em; height: 0px;"><span style="position: absolute; clip: rect(3.828em, 1000em, 4.151em, -999.997em); top: -3.984em; left: 0em;"><span class="mi" id="MathJax-Span-121" style="font-size: 70.7%;"></span><span style="display: inline-block; width: 0px; height: 3.99em;"></span></span><span style="position: absolute; top: -4.254em; left: 0em;"><span class="mo" id="MathJax-Span-122" style="font-size: 50%; font-family: MathJax_Main;">′</span><span style="display: inline-block; width: 0px; height: 3.99em;"></span></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 3.99em;"></span></span><span style="position: absolute; clip: rect(3.343em, 1000.6em, 4.151em, -999.997em); top: -3.661em; left: 0.541em;"><span class="mi" id="MathJax-Span-123" style="font-size: 70.7%; font-family: MathJax_Math-italic;">T<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.11em;"></span></span><span style="display: inline-block; width: 0px; height: 3.99em;"></span></span></span></span><span class="mo" id="MathJax-Span-124" style="font-family: MathJax_Main; padding-left: 0.218em;">⊕</span><span class="mi" id="MathJax-Span-125" style="font-family: MathJax_Math-italic; padding-left: 0.218em;">k</span><span class="msubsup" id="MathJax-Span-126"><span style="display: inline-block; position: relative; width: 0.919em; height: 0px;"><span style="position: absolute; clip: rect(3.397em, 1000.43em, 4.151em, -999.997em); top: -3.984em; left: 0em;"><span class="mi" id="MathJax-Span-127" style="font-family: MathJax_Math-italic;">s</span><span style="display: inline-block; width: 0px; height: 3.99em;"></span></span><span style="position: absolute; top: -3.823em; left: 0.488em;"><span class="mn" id="MathJax-Span-128" style="font-size: 70.7%; font-family: MathJax_Main;">3</span><span style="display: inline-block; width: 0px; height: 3.99em;"></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 2.373em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.434em; border-left: 0px solid; width: 0px; height: 1.503em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><msubsup><mi>a</mi><mi>T</mi><mrow class="MJX-TeXAtom-ORD"><msup><mi></mi><mo>′</mo></msup></mrow></msubsup><mo>⊕</mo><mi>k</mi><msub><mi>s</mi><mn>3</mn></msub></math></span></span><script type="math/tex" id="MathJax-Element-20">a_T^{'}  \oplus ks_3</script></span> ，虽然用来加密的 <span class="mathjax"><span class="MathJax_Preview" style="color: inherit;"></span><span class="MathJax" id="MathJax-Element-21-Frame" tabindex="0" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>k</mi><msub><mi>s</mi><mn>3</mn></msub></math>" role="presentation" style="position: relative;"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-129" style="width: 1.727em; display: inline-block;"><span style="display: inline-block; position: relative; width: 1.457em; height: 0px; font-size: 116%;"><span style="position: absolute; clip: rect(1.511em, 1001.46em, 2.697em, -999.997em); top: -2.368em; left: 0em;"><span class="mrow" id="MathJax-Span-130"><span class="mi" id="MathJax-Span-131" style="font-family: MathJax_Math-italic;">k</span><span class="msubsup" id="MathJax-Span-132"><span style="display: inline-block; position: relative; width: 0.919em; height: 0px;"><span style="position: absolute; clip: rect(3.397em, 1000.43em, 4.151em, -999.997em); top: -3.984em; left: 0em;"><span class="mi" id="MathJax-Span-133" style="font-family: MathJax_Math-italic;">s</span><span style="display: inline-block; width: 0px; height: 3.99em;"></span></span><span style="position: absolute; top: -3.823em; left: 0.488em;"><span class="mn" id="MathJax-Span-134" style="font-size: 70.7%; font-family: MathJax_Main;">3</span><span style="display: inline-block; width: 0px; height: 3.99em;"></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 2.373em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.128em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>k</mi><msub><mi>s</mi><mn>3</mn></msub></math></span></span><script type="math/tex" id="MathJax-Element-21">ks_3</script></span> 是未知的，我们把它们相加就互相抵消了 <span class="mathjax"><span class="MathJax_Preview" style="color: inherit;"></span><span class="MathJax" id="MathJax-Element-22-Frame" tabindex="0" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>a</mi><mi>T</mi></msub><mo>&amp;#x2295;</mo><mi>k</mi><msub><mi>s</mi><mn>3</mn></msub><mo>&amp;#x2295;</mo><msubsup><mi>a</mi><mi>T</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><msup><mi></mi><mo>&amp;#x2032;</mo></msup></mrow></msubsup><mo>&amp;#x2295;</mo><mi>k</mi><msub><mi>s</mi><mn>3</mn></msub><mo>=</mo><msub><mi>a</mi><mi>T</mi></msub><mo>&amp;#x2295;</mo><msubsup><mi>a</mi><mi>T</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><msup><mi></mi><mo>&amp;#x2032;</mo></msup></mrow></msubsup><mo>&amp;#x2295;</mo><mi>k</mi><msub><mi>s</mi><mn>3</mn></msub><mo>&amp;#x2295;</mo><mi>k</mi><msub><mi>s</mi><mn>3</mn></msub></math>" role="presentation" style="position: relative;"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-135" style="width: 21.716em; display: inline-block;"><span style="display: inline-block; position: relative; width: 18.699em; height: 0px; font-size: 116%;"><span style="position: absolute; clip: rect(1.35em, 1018.7em, 2.858em, -999.997em); top: -2.368em; left: 0em;"><span class="mrow" id="MathJax-Span-136"><span class="msubsup" id="MathJax-Span-137"><span style="display: inline-block; position: relative; width: 1.08em; height: 0px;"><span style="position: absolute; clip: rect(3.397em, 1000.49em, 4.151em, -999.997em); top: -3.984em; left: 0em;"><span class="mi" id="MathJax-Span-138" style="font-family: MathJax_Math-italic;">a</span><span style="display: inline-block; width: 0px; height: 3.99em;"></span></span><span style="position: absolute; top: -3.823em; left: 0.541em;"><span class="mi" id="MathJax-Span-139" style="font-size: 70.7%; font-family: MathJax_Math-italic;">T<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.11em;"></span></span><span style="display: inline-block; width: 0px; height: 3.99em;"></span></span></span></span><span class="mo" id="MathJax-Span-140" style="font-family: MathJax_Main; padding-left: 0.218em;">⊕</span><span class="mi" id="MathJax-Span-141" style="font-family: MathJax_Math-italic; padding-left: 0.218em;">k</span><span class="msubsup" id="MathJax-Span-142"><span style="display: inline-block; position: relative; width: 0.919em; height: 0px;"><span style="position: absolute; clip: rect(3.397em, 1000.43em, 4.151em, -999.997em); top: -3.984em; left: 0em;"><span class="mi" id="MathJax-Span-143" style="font-family: MathJax_Math-italic;">s</span><span style="display: inline-block; width: 0px; height: 3.99em;"></span></span><span style="position: absolute; top: -3.823em; left: 0.488em;"><span class="mn" id="MathJax-Span-144" style="font-size: 70.7%; font-family: MathJax_Main;">3</span><span style="display: inline-block; width: 0px; height: 3.99em;"></span></span></span></span><span class="mo" id="MathJax-Span-145" style="font-family: MathJax_Main; padding-left: 0.218em;">⊕</span><span class="msubsup" id="MathJax-Span-146" style="padding-left: 0.218em;"><span style="display: inline-block; position: relative; width: 1.08em; height: 0px;"><span style="position: absolute; clip: rect(3.397em, 1000.49em, 4.151em, -999.997em); top: -3.984em; left: 0em;"><span class="mi" id="MathJax-Span-147" style="font-family: MathJax_Math-italic;">a</span><span style="display: inline-block; width: 0px; height: 3.99em;"></span></span><span style="position: absolute; clip: rect(3.289em, 1000.27em, 4.151em, -999.997em); top: -4.308em; left: 0.541em;"><span class="texatom" id="MathJax-Span-148"><span class="mrow" id="MathJax-Span-149"><span class="msup" id="MathJax-Span-150"><span style="display: inline-block; position: relative; width: 0.218em; height: 0px;"><span style="position: absolute; clip: rect(3.828em, 1000em, 4.151em, -999.997em); top: -3.984em; left: 0em;"><span class="mi" id="MathJax-Span-151" style="font-size: 70.7%;"></span><span style="display: inline-block; width: 0px; height: 3.99em;"></span></span><span style="position: absolute; top: -4.254em; left: 0em;"><span class="mo" id="MathJax-Span-152" style="font-size: 50%; font-family: MathJax_Main;">′</span><span style="display: inline-block; width: 0px; height: 3.99em;"></span></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 3.99em;"></span></span><span style="position: absolute; clip: rect(3.343em, 1000.6em, 4.151em, -999.997em); top: -3.661em; left: 0.541em;"><span class="mi" id="MathJax-Span-153" style="font-size: 70.7%; font-family: MathJax_Math-italic;">T<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.11em;"></span></span><span style="display: inline-block; width: 0px; height: 3.99em;"></span></span></span></span><span class="mo" id="MathJax-Span-154" style="font-family: MathJax_Main; padding-left: 0.218em;">⊕</span><span class="mi" id="MathJax-Span-155" style="font-family: MathJax_Math-italic; padding-left: 0.218em;">k</span><span class="msubsup" id="MathJax-Span-156"><span style="display: inline-block; position: relative; width: 0.919em; height: 0px;"><span style="position: absolute; clip: rect(3.397em, 1000.43em, 4.151em, -999.997em); top: -3.984em; left: 0em;"><span class="mi" id="MathJax-Span-157" style="font-family: MathJax_Math-italic;">s</span><span style="display: inline-block; width: 0px; height: 3.99em;"></span></span><span style="position: absolute; top: -3.823em; left: 0.488em;"><span class="mn" id="MathJax-Span-158" style="font-size: 70.7%; font-family: MathJax_Main;">3</span><span style="display: inline-block; width: 0px; height: 3.99em;"></span></span></span></span><span class="mo" id="MathJax-Span-159" style="font-family: MathJax_Main; padding-left: 0.272em;">=</span><span class="msubsup" id="MathJax-Span-160" style="padding-left: 0.272em;"><span style="display: inline-block; position: relative; width: 1.08em; height: 0px;"><span style="position: absolute; clip: rect(3.397em, 1000.49em, 4.151em, -999.997em); top: -3.984em; left: 0em;"><span class="mi" id="MathJax-Span-161" style="font-family: MathJax_Math-italic;">a</span><span style="display: inline-block; width: 0px; height: 3.99em;"></span></span><span style="position: absolute; top: -3.823em; left: 0.541em;"><span class="mi" id="MathJax-Span-162" style="font-size: 70.7%; font-family: MathJax_Math-italic;">T<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.11em;"></span></span><span style="display: inline-block; width: 0px; height: 3.99em;"></span></span></span></span><span class="mo" id="MathJax-Span-163" style="font-family: MathJax_Main; padding-left: 0.218em;">⊕</span><span class="msubsup" id="MathJax-Span-164" style="padding-left: 0.218em;"><span style="display: inline-block; position: relative; width: 1.08em; height: 0px;"><span style="position: absolute; clip: rect(3.397em, 1000.49em, 4.151em, -999.997em); top: -3.984em; left: 0em;"><span class="mi" id="MathJax-Span-165" style="font-family: MathJax_Math-italic;">a</span><span style="display: inline-block; width: 0px; height: 3.99em;"></span></span><span style="position: absolute; clip: rect(3.289em, 1000.27em, 4.151em, -999.997em); top: -4.308em; left: 0.541em;"><span class="texatom" id="MathJax-Span-166"><span class="mrow" id="MathJax-Span-167"><span class="msup" id="MathJax-Span-168"><span style="display: inline-block; position: relative; width: 0.218em; height: 0px;"><span style="position: absolute; clip: rect(3.828em, 1000em, 4.151em, -999.997em); top: -3.984em; left: 0em;"><span class="mi" id="MathJax-Span-169" style="font-size: 70.7%;"></span><span style="display: inline-block; width: 0px; height: 3.99em;"></span></span><span style="position: absolute; top: -4.254em; left: 0em;"><span class="mo" id="MathJax-Span-170" style="font-size: 50%; font-family: MathJax_Main;">′</span><span style="display: inline-block; width: 0px; height: 3.99em;"></span></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 3.99em;"></span></span><span style="position: absolute; clip: rect(3.343em, 1000.6em, 4.151em, -999.997em); top: -3.661em; left: 0.541em;"><span class="mi" id="MathJax-Span-171" style="font-size: 70.7%; font-family: MathJax_Math-italic;">T<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.11em;"></span></span><span style="display: inline-block; width: 0px; height: 3.99em;"></span></span></span></span><span class="mo" id="MathJax-Span-172" style="font-family: MathJax_Main; padding-left: 0.218em;">⊕</span><span class="mi" id="MathJax-Span-173" style="font-family: MathJax_Math-italic; padding-left: 0.218em;">k</span><span class="msubsup" id="MathJax-Span-174"><span style="display: inline-block; position: relative; width: 0.919em; height: 0px;"><span style="position: absolute; clip: rect(3.397em, 1000.43em, 4.151em, -999.997em); top: -3.984em; left: 0em;"><span class="mi" id="MathJax-Span-175" style="font-family: MathJax_Math-italic;">s</span><span style="display: inline-block; width: 0px; height: 3.99em;"></span></span><span style="position: absolute; top: -3.823em; left: 0.488em;"><span class="mn" id="MathJax-Span-176" style="font-size: 70.7%; font-family: MathJax_Main;">3</span><span style="display: inline-block; width: 0px; height: 3.99em;"></span></span></span></span><span class="mo" id="MathJax-Span-177" style="font-family: MathJax_Main; padding-left: 0.218em;">⊕</span><span class="mi" id="MathJax-Span-178" style="font-family: MathJax_Math-italic; padding-left: 0.218em;">k</span><span class="msubsup" id="MathJax-Span-179"><span style="display: inline-block; position: relative; width: 0.919em; height: 0px;"><span style="position: absolute; clip: rect(3.397em, 1000.43em, 4.151em, -999.997em); top: -3.984em; left: 0em;"><span class="mi" id="MathJax-Span-180" style="font-family: MathJax_Math-italic;">s</span><span style="display: inline-block; width: 0px; height: 3.99em;"></span></span><span style="position: absolute; top: -3.823em; left: 0.488em;"><span class="mn" id="MathJax-Span-181" style="font-size: 70.7%; font-family: MathJax_Main;">3</span><span style="display: inline-block; width: 0px; height: 3.99em;"></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 2.373em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.434em; border-left: 0px solid; width: 0px; height: 1.503em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><msub><mi>a</mi><mi>T</mi></msub><mo>⊕</mo><mi>k</mi><msub><mi>s</mi><mn>3</mn></msub><mo>⊕</mo><msubsup><mi>a</mi><mi>T</mi><mrow class="MJX-TeXAtom-ORD"><msup><mi></mi><mo>′</mo></msup></mrow></msubsup><mo>⊕</mo><mi>k</mi><msub><mi>s</mi><mn>3</mn></msub><mo>=</mo><msub><mi>a</mi><mi>T</mi></msub><mo>⊕</mo><msubsup><mi>a</mi><mi>T</mi><mrow class="MJX-TeXAtom-ORD"><msup><mi></mi><mo>′</mo></msup></mrow></msubsup><mo>⊕</mo><mi>k</mi><msub><mi>s</mi><mn>3</mn></msub><mo>⊕</mo><mi>k</mi><msub><mi>s</mi><mn>3</mn></msub></math></span></span><script type="math/tex" id="MathJax-Element-22">a_T\oplus ks_3 \oplus a_T^{'}\oplus ks_3 = a_T \oplus a_T^{'} \oplus ks_3 \oplus ks_3</script></span>，因为 <span class="mathjax"><span class="MathJax_Preview" style="color: inherit;"></span><span class="MathJax" id="MathJax-Element-23-Frame" tabindex="0" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>k</mi><msub><mi>s</mi><mn>3</mn></msub><mo>&amp;#x2295;</mo><mi>k</mi><msub><mi>s</mi><mn>3</mn></msub><mo>=</mo><mn>0</mn></math>" role="presentation" style="position: relative;"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-182" style="width: 6.899em; display: inline-block;"><span style="display: inline-block; position: relative; width: 5.929em; height: 0px; font-size: 116%;"><span style="position: absolute; clip: rect(1.511em, 1005.88em, 2.697em, -999.997em); top: -2.368em; left: 0em;"><span class="mrow" id="MathJax-Span-183"><span class="mi" id="MathJax-Span-184" style="font-family: MathJax_Math-italic;">k</span><span class="msubsup" id="MathJax-Span-185"><span style="display: inline-block; position: relative; width: 0.919em; height: 0px;"><span style="position: absolute; clip: rect(3.397em, 1000.43em, 4.151em, -999.997em); top: -3.984em; left: 0em;"><span class="mi" id="MathJax-Span-186" style="font-family: MathJax_Math-italic;">s</span><span style="display: inline-block; width: 0px; height: 3.99em;"></span></span><span style="position: absolute; top: -3.823em; left: 0.488em;"><span class="mn" id="MathJax-Span-187" style="font-size: 70.7%; font-family: MathJax_Main;">3</span><span style="display: inline-block; width: 0px; height: 3.99em;"></span></span></span></span><span class="mo" id="MathJax-Span-188" style="font-family: MathJax_Main; padding-left: 0.218em;">⊕</span><span class="mi" id="MathJax-Span-189" style="font-family: MathJax_Math-italic; padding-left: 0.218em;">k</span><span class="msubsup" id="MathJax-Span-190"><span style="display: inline-block; position: relative; width: 0.919em; height: 0px;"><span style="position: absolute; clip: rect(3.397em, 1000.43em, 4.151em, -999.997em); top: -3.984em; left: 0em;"><span class="mi" id="MathJax-Span-191" style="font-family: MathJax_Math-italic;">s</span><span style="display: inline-block; width: 0px; height: 3.99em;"></span></span><span style="position: absolute; top: -3.823em; left: 0.488em;"><span class="mn" id="MathJax-Span-192" style="font-size: 70.7%; font-family: MathJax_Main;">3</span><span style="display: inline-block; width: 0px; height: 3.99em;"></span></span></span></span><span class="mo" id="MathJax-Span-193" style="font-family: MathJax_Main; padding-left: 0.272em;">=</span><span class="mn" id="MathJax-Span-194" style="font-family: MathJax_Main; padding-left: 0.272em;">0</span></span><span style="display: inline-block; width: 0px; height: 2.373em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.128em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>k</mi><msub><mi>s</mi><mn>3</mn></msub><mo>⊕</mo><mi>k</mi><msub><mi>s</mi><mn>3</mn></msub><mo>=</mo><mn>0</mn></math></span></span><script type="math/tex" id="MathJax-Element-23">ks_3 \oplus ks_3 = 0</script></span> ，我们就得到了没有加密的 <span class="mathjax"><span class="MathJax_Preview" style="color: inherit;"></span><span class="MathJax" id="MathJax-Element-24-Frame" tabindex="0" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>a</mi><mi>T</mi></msub><mo>&amp;#x2295;</mo><msub><mi>a</mi><mi>T</mi></msub><mrow class=&quot;MJX-TeXAtom-ORD&quot;><msup><mi></mi><mo>&amp;#x2032;</mo></msup></mrow></math>" role="presentation" style="position: relative;"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-195" style="width: 4.259em; display: inline-block;"><span style="display: inline-block; position: relative; width: 3.666em; height: 0px; font-size: 116%;"><span style="position: absolute; clip: rect(1.457em, 1003.67em, 2.697em, -999.997em); top: -2.368em; left: 0em;"><span class="mrow" id="MathJax-Span-196"><span class="msubsup" id="MathJax-Span-197"><span style="display: inline-block; position: relative; width: 1.08em; height: 0px;"><span style="position: absolute; clip: rect(3.397em, 1000.49em, 4.151em, -999.997em); top: -3.984em; left: 0em;"><span class="mi" id="MathJax-Span-198" style="font-family: MathJax_Math-italic;">a</span><span style="display: inline-block; width: 0px; height: 3.99em;"></span></span><span style="position: absolute; top: -3.823em; left: 0.541em;"><span class="mi" id="MathJax-Span-199" style="font-size: 70.7%; font-family: MathJax_Math-italic;">T<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.11em;"></span></span><span style="display: inline-block; width: 0px; height: 3.99em;"></span></span></span></span><span class="mo" id="MathJax-Span-200" style="font-family: MathJax_Main; padding-left: 0.218em;">⊕</span><span class="msubsup" id="MathJax-Span-201" style="padding-left: 0.218em;"><span style="display: inline-block; position: relative; width: 1.08em; height: 0px;"><span style="position: absolute; clip: rect(3.397em, 1000.49em, 4.151em, -999.997em); top: -3.984em; left: 0em;"><span class="mi" id="MathJax-Span-202" style="font-family: MathJax_Math-italic;">a</span><span style="display: inline-block; width: 0px; height: 3.99em;"></span></span><span style="position: absolute; top: -3.823em; left: 0.541em;"><span class="mi" id="MathJax-Span-203" style="font-size: 70.7%; font-family: MathJax_Math-italic;">T<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.11em;"></span></span><span style="display: inline-block; width: 0px; height: 3.99em;"></span></span></span></span><span class="texatom" id="MathJax-Span-204"><span class="mrow" id="MathJax-Span-205"><span class="msup" id="MathJax-Span-206"><span style="display: inline-block; position: relative; width: 0.272em; height: 0px;"><span style="position: absolute; clip: rect(3.828em, 1000em, 4.151em, -999.997em); top: -3.984em; left: 0em;"><span class="mi" id="MathJax-Span-207"></span><span style="display: inline-block; width: 0px; height: 3.99em;"></span></span><span style="position: absolute; top: -4.362em; left: 0em;"><span class="mo" id="MathJax-Span-208" style="font-size: 70.7%; font-family: MathJax_Main;">′</span><span style="display: inline-block; width: 0px; height: 3.99em;"></span></span></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 2.373em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.191em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><msub><mi>a</mi><mi>T</mi></msub><mo>⊕</mo><msub><mi>a</mi><mi>T</mi></msub><mrow class="MJX-TeXAtom-ORD"><msup><mi></mi><mo>′</mo></msup></mrow></math></span></span><script type="math/tex" id="MathJax-Element-24">a_T \oplus a_T{'}</script></span>，其中 <span class="mathjax"><span class="MathJax_Preview" style="color: inherit;"></span><span class="MathJax" id="MathJax-Element-25-Frame" tabindex="0" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>a</mi><mi>T</mi></msub></math>" role="presentation" style="position: relative;"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-209" style="width: 1.242em; display: inline-block;"><span style="display: inline-block; position: relative; width: 1.08em; height: 0px; font-size: 116%;"><span style="position: absolute; clip: rect(1.781em, 1001.08em, 2.697em, -999.997em); top: -2.368em; left: 0em;"><span class="mrow" id="MathJax-Span-210"><span class="msubsup" id="MathJax-Span-211"><span style="display: inline-block; position: relative; width: 1.08em; height: 0px;"><span style="position: absolute; clip: rect(3.397em, 1000.49em, 4.151em, -999.997em); top: -3.984em; left: 0em;"><span class="mi" id="MathJax-Span-212" style="font-family: MathJax_Math-italic;">a</span><span style="display: inline-block; width: 0px; height: 3.99em;"></span></span><span style="position: absolute; top: -3.823em; left: 0.541em;"><span class="mi" id="MathJax-Span-213" style="font-size: 70.7%; font-family: MathJax_Math-italic;">T<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.11em;"></span></span><span style="display: inline-block; width: 0px; height: 3.99em;"></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 2.373em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 0.816em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><msub><mi>a</mi><mi>T</mi></msub></math></span></span><script type="math/tex" id="MathJax-Element-25">a_T</script></span> 代表卡 Tag (T) 的相应 Answer (a)。</p><p>除了前面提到的 PRNG 生成的序列和上电时间有关，是可以控制的。一些读卡器在图上第 8 行的时候，如果 NFC 卡什么也不发送，读卡器超时后在第 9 行会返回一个关机命令 halt <span class="mathjax"><span class="MathJax_Preview" style="color: inherit;"></span><span class="MathJax" id="MathJax-Element-26-Frame" tabindex="0" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mo>&amp;#x2295;</mo><mi>k</mi><msub><mi>s</mi><mn>3</mn></msub></math>" role="presentation" style="position: relative;"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-214" style="width: 2.589em; display: inline-block;"><span style="display: inline-block; position: relative; width: 2.212em; height: 0px; font-size: 116%;"><span style="position: absolute; clip: rect(1.511em, 1002.21em, 2.697em, -999.997em); top: -2.368em; left: 0em;"><span class="mrow" id="MathJax-Span-215"><span class="mo" id="MathJax-Span-216" style="font-family: MathJax_Main;">⊕</span><span class="mi" id="MathJax-Span-217" style="font-family: MathJax_Math-italic;">k</span><span class="msubsup" id="MathJax-Span-218"><span style="display: inline-block; position: relative; width: 0.919em; height: 0px;"><span style="position: absolute; clip: rect(3.397em, 1000.43em, 4.151em, -999.997em); top: -3.984em; left: 0em;"><span class="mi" id="MathJax-Span-219" style="font-family: MathJax_Math-italic;">s</span><span style="display: inline-block; width: 0px; height: 3.99em;"></span></span><span style="position: absolute; top: -3.823em; left: 0.488em;"><span class="mn" id="MathJax-Span-220" style="font-size: 70.7%; font-family: MathJax_Main;">3</span><span style="display: inline-block; width: 0px; height: 3.99em;"></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 2.373em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.128em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mo>⊕</mo><mi>k</mi><msub><mi>s</mi><mn>3</mn></msub></math></span></span><script type="math/tex" id="MathJax-Element-26">\oplus ks_3</script></span> 。然而不幸的是，halt 命令是由 ISO1443 规定的已知值，这样我们已知 halt 和 halt <span class="mathjax"><span class="MathJax_Preview" style="color: inherit;"></span><span class="MathJax" id="MathJax-Element-27-Frame" tabindex="0" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mo>&amp;#x2295;</mo><mi>k</mi><msub><mi>s</mi><mn>3</mn></msub></math>" role="presentation" style="position: relative;"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-221" style="width: 2.589em; display: inline-block;"><span style="display: inline-block; position: relative; width: 2.212em; height: 0px; font-size: 116%;"><span style="position: absolute; clip: rect(1.511em, 1002.21em, 2.697em, -999.997em); top: -2.368em; left: 0em;"><span class="mrow" id="MathJax-Span-222"><span class="mo" id="MathJax-Span-223" style="font-family: MathJax_Main;">⊕</span><span class="mi" id="MathJax-Span-224" style="font-family: MathJax_Math-italic;">k</span><span class="msubsup" id="MathJax-Span-225"><span style="display: inline-block; position: relative; width: 0.919em; height: 0px;"><span style="position: absolute; clip: rect(3.397em, 1000.43em, 4.151em, -999.997em); top: -3.984em; left: 0em;"><span class="mi" id="MathJax-Span-226" style="font-family: MathJax_Math-italic;">s</span><span style="display: inline-block; width: 0px; height: 3.99em;"></span></span><span style="position: absolute; top: -3.823em; left: 0.488em;"><span class="mn" id="MathJax-Span-227" style="font-size: 70.7%; font-family: MathJax_Main;">3</span><span style="display: inline-block; width: 0px; height: 3.99em;"></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 2.373em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.128em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mo>⊕</mo><mi>k</mi><msub><mi>s</mi><mn>3</mn></msub></math></span></span><script type="math/tex" id="MathJax-Element-27">\oplus ks_3</script></span>，意味着我们可以计算得到 <span class="mathjax"><span class="MathJax_Preview" style="color: inherit;"></span><span class="MathJax" id="MathJax-Element-28-Frame" tabindex="0" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>k</mi><msub><mi>s</mi><mn>3</mn></msub></math>" role="presentation" style="position: relative;"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-228" style="width: 1.727em; display: inline-block;"><span style="display: inline-block; position: relative; width: 1.457em; height: 0px; font-size: 116%;"><span style="position: absolute; clip: rect(1.511em, 1001.46em, 2.697em, -999.997em); top: -2.368em; left: 0em;"><span class="mrow" id="MathJax-Span-229"><span class="mi" id="MathJax-Span-230" style="font-family: MathJax_Math-italic;">k</span><span class="msubsup" id="MathJax-Span-231"><span style="display: inline-block; position: relative; width: 0.919em; height: 0px;"><span style="position: absolute; clip: rect(3.397em, 1000.43em, 4.151em, -999.997em); top: -3.984em; left: 0em;"><span class="mi" id="MathJax-Span-232" style="font-family: MathJax_Math-italic;">s</span><span style="display: inline-block; width: 0px; height: 3.99em;"></span></span><span style="position: absolute; top: -3.823em; left: 0.488em;"><span class="mn" id="MathJax-Span-233" style="font-size: 70.7%; font-family: MathJax_Main;">3</span><span style="display: inline-block; width: 0px; height: 3.99em;"></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 2.373em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.128em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>k</mi><msub><mi>s</mi><mn>3</mn></msub></math></span></span><script type="math/tex" id="MathJax-Element-28">ks_3</script></span> 从而恢复一部分 keystream。</p><p>当然，Authentication 还有很多其他的漏洞，例如 Nested Authentication，M1 卡一共有 16 个 Block，我们可以在知道某一个 Block 的密钥后，用它来认证其他的 Block。打个比方，通常 NFC 内部的 1K 存储不会全部用完，这就意味着有些 Block 会使用默认的密钥 FF FF FF FF FF FF，我们就可以利用这些 Block 默认的密钥来认证其他的 Block。</p><p>最后有了足够多的 keystream，我们就可以还原内部 Crypto1 的  LFSR 设计了。</p><p><strong>尽管 Authentication 部分的漏洞很多，这些漏洞不涉及核心加密算法，是可以打补丁修复的</strong>，例如前面提到的可以利用已知的 halt 指令得到 <span class="mathjax"><span class="MathJax_Preview" style="color: inherit;"></span><span class="MathJax" id="MathJax-Element-29-Frame" tabindex="0" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>k</mi><msub><mi>s</mi><mn>3</mn></msub></math>" role="presentation" style="position: relative;"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-234" style="width: 1.727em; display: inline-block;"><span style="display: inline-block; position: relative; width: 1.457em; height: 0px; font-size: 116%;"><span style="position: absolute; clip: rect(1.511em, 1001.46em, 2.697em, -999.997em); top: -2.368em; left: 0em;"><span class="mrow" id="MathJax-Span-235"><span class="mi" id="MathJax-Span-236" style="font-family: MathJax_Math-italic;">k</span><span class="msubsup" id="MathJax-Span-237"><span style="display: inline-block; position: relative; width: 0.919em; height: 0px;"><span style="position: absolute; clip: rect(3.397em, 1000.43em, 4.151em, -999.997em); top: -3.984em; left: 0em;"><span class="mi" id="MathJax-Span-238" style="font-family: MathJax_Math-italic;">s</span><span style="display: inline-block; width: 0px; height: 3.99em;"></span></span><span style="position: absolute; top: -3.823em; left: 0.488em;"><span class="mn" id="MathJax-Span-239" style="font-size: 70.7%; font-family: MathJax_Main;">3</span><span style="display: inline-block; width: 0px; height: 3.99em;"></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 2.373em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.128em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>k</mi><msub><mi>s</mi><mn>3</mn></msub></math></span></span><script type="math/tex" id="MathJax-Element-29">ks_3</script></span> ，只要读卡器超时不发送 halt 指令就修复了漏洞。NXP 也确实修复了几次 Authentication 的漏洞，不过不断又有新的漏洞被发现。</p><h2 id="破解3：Crypto1" style=""><a class="anchor hidden-xs" href="#破解3：Crypto1" title="破解3：Crypto1"><i class="fa fa-link"></i></a>破解3：Crypto1</h2><p>前面提到，Authentication 的漏洞可以通过打补丁修复，只要没有威胁到核心的 Cryto1 算法，M1 卡打打补丁又能用。 然而，非常不幸的是，2015 年 M1 卡的核心 Crypto1 算法也被成功破解了 [2]，攻击者可以在一分钟内搜寻得到密钥，这也彻底宣告了 M1 卡的终结，虽然实际上直到 2023 年国内外依旧还在用 M1 卡。</p><p>早期不知道 Crypto1 算法细节的时候，只有 读卡器 和 M1 卡有硬件的算法实现，但是毕竟这两个设备计算能力都不强，利用它们进行遍历，暴力破解 (Brute Force) 的话计算速度实在太慢，再加上 Authentication 的一些延迟，尝试一次可能需要花费 0.5 秒。</p><p>然而 Crypto1 的算法细节被公开后，我们可以在高性能的计算机上进行暴力破解。如果使用前面提到的 mfoc 暴力破解，在个人笔记本上 (i5 八核) 大约只需要 2 个小时左右。</p><p>更让 NXP 绝望的是，在 2015 年，密码分析学快速发展多年后，Carlo Meijer 找到了 Crypto1 核心加密算法的漏洞 [2]，从此破解 M1 卡只需要一分钟左右 (mfoc-hardnested)，彻底宣告了 M1 卡的终结。</p><p><img src="" alt="img"></p><p>上面这张图是 Crypto1 Stream Cipher 的初始化过程。在 Crypto1 加密细节公开后，对于一个 Stream Cipher 而言，只要能弄清内部状态是如何初始化的，我们就能生成一模一样的 keystream。</p><p>图上可以看到，Crypto1 是利用 ( <span class="mathjax"><span class="MathJax_Preview" style="color: inherit;"></span><span class="MathJax" id="MathJax-Element-30-Frame" tabindex="0" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>K</mi></math>" role="presentation" style="position: relative;"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-240" style="width: 1.08em; display: inline-block;"><span style="display: inline-block; position: relative; width: 0.919em; height: 0px; font-size: 116%;"><span style="position: absolute; clip: rect(1.511em, 1000.92em, 2.535em, -999.997em); top: -2.368em; left: 0em;"><span class="mrow" id="MathJax-Span-241"><span class="mi" id="MathJax-Span-242" style="font-family: MathJax_Math-italic;">K<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.057em;"></span></span></span><span style="display: inline-block; width: 0px; height: 2.373em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>K</mi></math></span></span><script type="math/tex" id="MathJax-Element-30">K</script></span>, <span class="mathjax"><span class="MathJax_Preview" style="color: inherit;"></span><span class="MathJax" id="MathJax-Element-31-Frame" tabindex="0" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>u</mi><mi>i</mi><mi>d</mi><mo>&amp;#x2295;</mo><msub><mi>n</mi><mi>T</mi></msub></math>" role="presentation" style="position: relative;"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-243" style="width: 4.475em; display: inline-block;"><span style="display: inline-block; position: relative; width: 3.828em; height: 0px; font-size: 116%;"><span style="position: absolute; clip: rect(1.511em, 1003.83em, 2.697em, -999.997em); top: -2.368em; left: 0em;"><span class="mrow" id="MathJax-Span-244"><span class="mi" id="MathJax-Span-245" style="font-family: MathJax_Math-italic;">u</span><span class="mi" id="MathJax-Span-246" style="font-family: MathJax_Math-italic;">i</span><span class="mi" id="MathJax-Span-247" style="font-family: MathJax_Math-italic;">d<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.003em;"></span></span><span class="mo" id="MathJax-Span-248" style="font-family: MathJax_Main; padding-left: 0.218em;">⊕</span><span class="msubsup" id="MathJax-Span-249" style="padding-left: 0.218em;"><span style="display: inline-block; position: relative; width: 1.188em; height: 0px;"><span style="position: absolute; clip: rect(3.397em, 1000.6em, 4.151em, -999.997em); top: -3.984em; left: 0em;"><span class="mi" id="MathJax-Span-250" style="font-family: MathJax_Math-italic;">n</span><span style="display: inline-block; width: 0px; height: 3.99em;"></span></span><span style="position: absolute; top: -3.823em; left: 0.595em;"><span class="mi" id="MathJax-Span-251" style="font-size: 70.7%; font-family: MathJax_Math-italic;">T<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.11em;"></span></span><span style="display: inline-block; width: 0px; height: 3.99em;"></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 2.373em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 1.128em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>u</mi><mi>i</mi><mi>d</mi><mo>⊕</mo><msub><mi>n</mi><mi>T</mi></msub></math></span></span><script type="math/tex" id="MathJax-Element-31">uid \oplus n_T</script></span>, <span class="mathjax"><span class="MathJax_Preview" style="color: inherit;"></span><span class="MathJax" id="MathJax-Element-32-Frame" tabindex="0" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>n</mi><mi>R</mi></msub></math>" role="presentation" style="position: relative;"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-252" style="width: 1.404em; display: inline-block;"><span style="display: inline-block; position: relative; width: 1.188em; height: 0px; font-size: 116%;"><span style="position: absolute; clip: rect(1.781em, 1001.19em, 2.697em, -999.997em); top: -2.368em; left: 0em;"><span class="mrow" id="MathJax-Span-253"><span class="msubsup" id="MathJax-Span-254"><span style="display: inline-block; position: relative; width: 1.188em; height: 0px;"><span style="position: absolute; clip: rect(3.397em, 1000.6em, 4.151em, -999.997em); top: -3.984em; left: 0em;"><span class="mi" id="MathJax-Span-255" style="font-family: MathJax_Math-italic;">n</span><span style="display: inline-block; width: 0px; height: 3.99em;"></span></span><span style="position: absolute; top: -3.823em; left: 0.595em;"><span class="mi" id="MathJax-Span-256" style="font-size: 70.7%; font-family: MathJax_Math-italic;">R</span><span style="display: inline-block; width: 0px; height: 3.99em;"></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 2.373em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 0.816em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><msub><mi>n</mi><mi>R</mi></msub></math></span></span><script type="math/tex" id="MathJax-Element-32">n_R</script></span>) 来初始化内部状态的，这也是为什么前面提到，只要  的值相同，  就是固定的 (由于 PRNG 的漏洞，我们可以通过控制上电时间生成一样的 Nonce)。</p><p>如果我们有一张要复制的 M1 卡，用来初始化内部状态的 ( , , ) 几个参数中，它的密钥 <span class="mathjax"><span class="MathJax_Preview" style="color: inherit;"></span><span class="MathJax" id="MathJax-Element-33-Frame" tabindex="0" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>K</mi></math>" role="presentation" style="position: relative;"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-257" style="width: 1.08em; display: inline-block;"><span style="display: inline-block; position: relative; width: 0.919em; height: 0px; font-size: 116%;"><span style="position: absolute; clip: rect(1.511em, 1000.92em, 2.535em, -999.997em); top: -2.368em; left: 0em;"><span class="mrow" id="MathJax-Span-258"><span class="mi" id="MathJax-Span-259" style="font-family: MathJax_Math-italic;">K<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.057em;"></span></span></span><span style="display: inline-block; width: 0px; height: 2.373em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>K</mi></math></span></span><script type="math/tex" id="MathJax-Element-33">K</script></span> 和 UID 都是固定的。由于我们已经知道了 Crypto1 的算法细节，我们可以通过收集一些 Nonce，来反复初始化 Crypto1 的状态，通过遍历尝试 <span class="mathjax"><span class="MathJax_Preview" style="color: inherit;"></span><span class="MathJax" id="MathJax-Element-34-Frame" tabindex="0" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msup><mn>2</mn><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mn>39</mn></mrow></msup></math>" role="presentation" style="position: relative;"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-260" style="width: 1.511em; display: inline-block;"><span style="display: inline-block; position: relative; width: 1.296em; height: 0px; font-size: 116%;"><span style="position: absolute; clip: rect(1.35em, 1001.3em, 2.535em, -999.997em); top: -2.368em; left: 0em;"><span class="mrow" id="MathJax-Span-261"><span class="msubsup" id="MathJax-Span-262"><span style="display: inline-block; position: relative; width: 1.296em; height: 0px;"><span style="position: absolute; clip: rect(3.182em, 1000.43em, 4.151em, -999.997em); top: -3.984em; left: 0em;"><span class="mn" id="MathJax-Span-263" style="font-family: MathJax_Main;">2</span><span style="display: inline-block; width: 0px; height: 3.99em;"></span></span><span style="position: absolute; top: -4.362em; left: 0.488em;"><span class="texatom" id="MathJax-Span-264"><span class="mrow" id="MathJax-Span-265"><span class="mn" id="MathJax-Span-266" style="font-size: 70.7%; font-family: MathJax_Main;">39</span></span></span><span style="display: inline-block; width: 0px; height: 3.99em;"></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 2.373em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 1.128em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><msup><mn>2</mn><mrow class="MJX-TeXAtom-ORD"><mn>39</mn></mrow></msup></math></span></span><script type="math/tex" id="MathJax-Element-34">2^{39}</script></span> 种可能的密钥 <span class="mathjax"><span class="MathJax_Preview" style="color: inherit;"></span><span class="MathJax" id="MathJax-Element-35-Frame" tabindex="0" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>K</mi></math>" role="presentation" style="position: relative;"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-267" style="width: 1.08em; display: inline-block;"><span style="display: inline-block; position: relative; width: 0.919em; height: 0px; font-size: 116%;"><span style="position: absolute; clip: rect(1.511em, 1000.92em, 2.535em, -999.997em); top: -2.368em; left: 0em;"><span class="mrow" id="MathJax-Span-268"><span class="mi" id="MathJax-Span-269" style="font-family: MathJax_Math-italic;">K<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.057em;"></span></span></span><span style="display: inline-block; width: 0px; height: 2.373em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>K</mi></math></span></span><script type="math/tex" id="MathJax-Element-35">K</script></span>，如果生成的  keystream 一模一样，说明我们尝试对 <span class="mathjax"><span class="MathJax_Preview" style="color: inherit;"></span><span class="MathJax" id="MathJax-Element-36-Frame" tabindex="0" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>K</mi></math>" role="presentation" style="position: relative;"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-270" style="width: 1.08em; display: inline-block;"><span style="display: inline-block; position: relative; width: 0.919em; height: 0px; font-size: 116%;"><span style="position: absolute; clip: rect(1.511em, 1000.92em, 2.535em, -999.997em); top: -2.368em; left: 0em;"><span class="mrow" id="MathJax-Span-271"><span class="mi" id="MathJax-Span-272" style="font-family: MathJax_Math-italic;">K<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.057em;"></span></span></span><span style="display: inline-block; width: 0px; height: 2.373em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>K</mi></math></span></span><script type="math/tex" id="MathJax-Element-36">K</script></span> 了。但是尝试 <span class="mathjax"><span class="MathJax_Preview" style="color: inherit;"></span><span class="MathJax" id="MathJax-Element-37-Frame" tabindex="0" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msup><mn>2</mn><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mn>39</mn></mrow></msup></math>" role="presentation" style="position: relative;"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-273" style="width: 1.511em; display: inline-block;"><span style="display: inline-block; position: relative; width: 1.296em; height: 0px; font-size: 116%;"><span style="position: absolute; clip: rect(1.35em, 1001.3em, 2.535em, -999.997em); top: -2.368em; left: 0em;"><span class="mrow" id="MathJax-Span-274"><span class="msubsup" id="MathJax-Span-275"><span style="display: inline-block; position: relative; width: 1.296em; height: 0px;"><span style="position: absolute; clip: rect(3.182em, 1000.43em, 4.151em, -999.997em); top: -3.984em; left: 0em;"><span class="mn" id="MathJax-Span-276" style="font-family: MathJax_Main;">2</span><span style="display: inline-block; width: 0px; height: 3.99em;"></span></span><span style="position: absolute; top: -4.362em; left: 0.488em;"><span class="texatom" id="MathJax-Span-277"><span class="mrow" id="MathJax-Span-278"><span class="mn" id="MathJax-Span-279" style="font-size: 70.7%; font-family: MathJax_Main;">39</span></span></span><span style="display: inline-block; width: 0px; height: 3.99em;"></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 2.373em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 1.128em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><msup><mn>2</mn><mrow class="MJX-TeXAtom-ORD"><mn>39</mn></mrow></msup></math></span></span><script type="math/tex" id="MathJax-Element-37">2^{39}</script></span> 种可能实在是太慢了，有没有办法减少需要尝试的 <span class="mathjax"><span class="MathJax_Preview" style="color: inherit;"></span><span class="MathJax" id="MathJax-Element-38-Frame" tabindex="0" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>K</mi></math>" role="presentation" style="position: relative;"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-280" style="width: 1.08em; display: inline-block;"><span style="display: inline-block; position: relative; width: 0.919em; height: 0px; font-size: 116%;"><span style="position: absolute; clip: rect(1.511em, 1000.92em, 2.535em, -999.997em); top: -2.368em; left: 0em;"><span class="mrow" id="MathJax-Span-281"><span class="mi" id="MathJax-Span-282" style="font-family: MathJax_Math-italic;">K<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.057em;"></span></span></span><span style="display: inline-block; width: 0px; height: 2.373em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>K</mi></math></span></span><script type="math/tex" id="MathJax-Element-38">K</script></span> 数量呢？</p><p>下面这张图是 Crypto1 生成 Keystream 的流程，我们可以看到它竟然只用奇数位生成 Keystream，例如 9,11,13,15 … 47 位。我们这样就可以把奇数位和偶数位分开，例如先固定 20 位偶数位，再固定 19 位奇数位，这样就只需要尝试 <span class="mathjax"><span class="MathJax_Preview" style="color: inherit;"></span><span class="MathJax" id="MathJax-Element-39-Frame" tabindex="0" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msup><mn>2</mn><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mn>20</mn></mrow></msup><mo>+</mo><msup><mn>2</mn><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mn>19</mn></mrow></msup><mo>=</mo><mn>1572864</mn><mo>&amp;#x2248;</mo><msup><mn>2</mn><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mn>20.58</mn></mrow></msup></math>" role="presentation" style="position: relative;"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-283" style="width: 14.119em; display: inline-block;"><span style="display: inline-block; position: relative; width: 12.179em; height: 0px; font-size: 116%;"><span style="position: absolute; clip: rect(1.35em, 1012.18em, 2.643em, -999.997em); top: -2.368em; left: 0em;"><span class="mrow" id="MathJax-Span-284"><span class="msubsup" id="MathJax-Span-285"><span style="display: inline-block; position: relative; width: 1.296em; height: 0px;"><span style="position: absolute; clip: rect(3.182em, 1000.43em, 4.151em, -999.997em); top: -3.984em; left: 0em;"><span class="mn" id="MathJax-Span-286" style="font-family: MathJax_Main;">2</span><span style="display: inline-block; width: 0px; height: 3.99em;"></span></span><span style="position: absolute; top: -4.362em; left: 0.488em;"><span class="texatom" id="MathJax-Span-287"><span class="mrow" id="MathJax-Span-288"><span class="mn" id="MathJax-Span-289" style="font-size: 70.7%; font-family: MathJax_Main;">20</span></span></span><span style="display: inline-block; width: 0px; height: 3.99em;"></span></span></span></span><span class="mo" id="MathJax-Span-290" style="font-family: MathJax_Main; padding-left: 0.218em;">+</span><span class="msubsup" id="MathJax-Span-291" style="padding-left: 0.218em;"><span style="display: inline-block; position: relative; width: 1.296em; height: 0px;"><span style="position: absolute; clip: rect(3.182em, 1000.43em, 4.151em, -999.997em); top: -3.984em; left: 0em;"><span class="mn" id="MathJax-Span-292" style="font-family: MathJax_Main;">2</span><span style="display: inline-block; width: 0px; height: 3.99em;"></span></span><span style="position: absolute; top: -4.362em; left: 0.488em;"><span class="texatom" id="MathJax-Span-293"><span class="mrow" id="MathJax-Span-294"><span class="mn" id="MathJax-Span-295" style="font-size: 70.7%; font-family: MathJax_Main;">19</span></span></span><span style="display: inline-block; width: 0px; height: 3.99em;"></span></span></span></span><span class="mo" id="MathJax-Span-296" style="font-family: MathJax_Main; padding-left: 0.272em;">=</span><span class="mn" id="MathJax-Span-297" style="font-family: MathJax_Main; padding-left: 0.272em;">1572864</span><span class="mo" id="MathJax-Span-298" style="font-family: MathJax_Main; padding-left: 0.272em;">≈</span><span class="msubsup" id="MathJax-Span-299" style="padding-left: 0.272em;"><span style="display: inline-block; position: relative; width: 2.212em; height: 0px;"><span style="position: absolute; clip: rect(3.182em, 1000.43em, 4.151em, -999.997em); top: -3.984em; left: 0em;"><span class="mn" id="MathJax-Span-300" style="font-family: MathJax_Main;">2</span><span style="display: inline-block; width: 0px; height: 3.99em;"></span></span><span style="position: absolute; top: -4.362em; left: 0.488em;"><span class="texatom" id="MathJax-Span-301"><span class="mrow" id="MathJax-Span-302"><span class="mn" id="MathJax-Span-303" style="font-size: 70.7%; font-family: MathJax_Main;">20.58</span></span></span><span style="display: inline-block; width: 0px; height: 3.99em;"></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 2.373em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.184em; border-left: 0px solid; width: 0px; height: 1.253em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><msup><mn>2</mn><mrow class="MJX-TeXAtom-ORD"><mn>20</mn></mrow></msup><mo>+</mo><msup><mn>2</mn><mrow class="MJX-TeXAtom-ORD"><mn>19</mn></mrow></msup><mo>=</mo><mn>1572864</mn><mo>≈</mo><msup><mn>2</mn><mrow class="MJX-TeXAtom-ORD"><mn>20.58</mn></mrow></msup></math></span></span><script type="math/tex" id="MathJax-Element-39">2^{20} + 2^{19} = 1572864 \approx 2^{20.58}</script></span> 种可能。</p><p>假如在 CPU 上计算，尝试一种可能需要 5ms (实际会更快)， <span class="mathjax"><span class="MathJax_Preview" style="color: inherit;"></span><span class="MathJax" id="MathJax-Element-40-Frame" tabindex="0" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mn>1572864</mn><mo>&amp;#x2217;</mo><mn>5</mn><mo>=</mo><mn>7864320</mn></math>" role="presentation" style="position: relative;"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-304" style="width: 11.317em; display: inline-block;"><span style="display: inline-block; position: relative; width: 9.755em; height: 0px; font-size: 116%;"><span style="position: absolute; clip: rect(1.511em, 1009.7em, 2.535em, -999.997em); top: -2.368em; left: 0em;"><span class="mrow" id="MathJax-Span-305"><span class="mn" id="MathJax-Span-306" style="font-family: MathJax_Main;">1572864</span><span class="mo" id="MathJax-Span-307" style="font-family: MathJax_Main; padding-left: 0.218em;">∗</span><span class="mn" id="MathJax-Span-308" style="font-family: MathJax_Main; padding-left: 0.218em;">5</span><span class="mo" id="MathJax-Span-309" style="font-family: MathJax_Main; padding-left: 0.272em;">=</span><span class="mn" id="MathJax-Span-310" style="font-family: MathJax_Main; padding-left: 0.272em;">7864320</span></span><span style="display: inline-block; width: 0px; height: 2.373em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mn>1572864</mn><mo>∗</mo><mn>5</mn><mo>=</mo><mn>7864320</mn></math></span></span><script type="math/tex" id="MathJax-Element-40">1572864 * 5 = 7864320</script></span> 毫秒，大约只需要 2 小时，这已经是可以接受的破解时间了。</p><p><img src="" alt="img"></p><p>然而，通过分析加密后的密文，可以进一步将搜寻空间从 <span class="mathjax"><span class="MathJax_Preview" style="color: inherit;"></span><span class="MathJax" id="MathJax-Element-41-Frame" tabindex="0" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msup><mn>2</mn><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mn>20.58</mn></mrow></msup></math>" role="presentation" style="position: relative;"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-311" style="width: 2.589em; display: inline-block;"><span style="display: inline-block; position: relative; width: 2.212em; height: 0px; font-size: 116%;"><span style="position: absolute; clip: rect(1.35em, 1002.21em, 2.535em, -999.997em); top: -2.368em; left: 0em;"><span class="mrow" id="MathJax-Span-312"><span class="msubsup" id="MathJax-Span-313"><span style="display: inline-block; position: relative; width: 2.212em; height: 0px;"><span style="position: absolute; clip: rect(3.182em, 1000.43em, 4.151em, -999.997em); top: -3.984em; left: 0em;"><span class="mn" id="MathJax-Span-314" style="font-family: MathJax_Main;">2</span><span style="display: inline-block; width: 0px; height: 3.99em;"></span></span><span style="position: absolute; top: -4.362em; left: 0.488em;"><span class="texatom" id="MathJax-Span-315"><span class="mrow" id="MathJax-Span-316"><span class="mn" id="MathJax-Span-317" style="font-size: 70.7%; font-family: MathJax_Main;">20.58</span></span></span><span style="display: inline-block; width: 0px; height: 3.99em;"></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 2.373em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 1.128em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><msup><mn>2</mn><mrow class="MJX-TeXAtom-ORD"><mn>20.58</mn></mrow></msup></math></span></span><script type="math/tex" id="MathJax-Element-41">2^{20.58}</script></span> 进一步减少，利用 Sum Property [2] 和 Filter Flip [3]，最终只需要1分钟内就能找到正确的密钥。</p><p>这里我们总结一下，破解的流程分为 3 步：</p><ol>
<li>利用 Nested Authentication 漏洞，搜集足够多的 Nonce。例如，M1 卡有 64 个 Block，不一定全部存满了数据，没有记录数据的 Block 通常用的出厂默认密钥，我们可以通过认证这个 Block 来读取别的未知 Block 数据。</li>
<li>利用 Sum Property 和 Filter Flip 来减少搜寻空间，减少可能的密钥数量</li>
<li>在电脑上暴力破解，遍历剩余可能的所有密钥。</li>
</ol><p>其中，第一步利用了 Authentication 的漏洞，最后一步是因为 Crypto1 的算法加密细节被逆向工程完全公开，导致我们可以在高性能计算机上快速尝试可能的密钥。<strong>最重要的是第二步，Sum Property 和 Filter Flip 大大减少了搜寻空间</strong>，以至于我们可以在个人笔记本上，只花1分钟就能计算完所有剩余的密钥。</p><p>这里简单介绍一下两个突破：Sum Property 和 Filter Flip，它们都是为了减少密钥  的搜寻空间。</p><h3 id="1-Sum-Property" style=""><a class="anchor hidden-xs" href="#1-Sum-Property" title="1-Sum-Property"><i class="fa fa-link"></i></a>1. Sum Property</h3><p>对于一个 32 位的 <span class="mathjax"><span class="MathJax_Preview" style="color: inherit;"></span><span class="MathJax" id="MathJax-Element-42-Frame" tabindex="0" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>n</mi><mi>T</mi></msub></math>" role="presentation" style="position: relative;"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-318" style="width: 1.404em; display: inline-block;"><span style="display: inline-block; position: relative; width: 1.188em; height: 0px; font-size: 116%;"><span style="position: absolute; clip: rect(1.781em, 1001.19em, 2.697em, -999.997em); top: -2.368em; left: 0em;"><span class="mrow" id="MathJax-Span-319"><span class="msubsup" id="MathJax-Span-320"><span style="display: inline-block; position: relative; width: 1.188em; height: 0px;"><span style="position: absolute; clip: rect(3.397em, 1000.6em, 4.151em, -999.997em); top: -3.984em; left: 0em;"><span class="mi" id="MathJax-Span-321" style="font-family: MathJax_Math-italic;">n</span><span style="display: inline-block; width: 0px; height: 3.99em;"></span></span><span style="position: absolute; top: -3.823em; left: 0.595em;"><span class="mi" id="MathJax-Span-322" style="font-size: 70.7%; font-family: MathJax_Math-italic;">T<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.11em;"></span></span><span style="display: inline-block; width: 0px; height: 3.99em;"></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 2.373em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 0.816em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><msub><mi>n</mi><mi>T</mi></msub></math></span></span><script type="math/tex" id="MathJax-Element-42">n_T</script></span>，我们可以把它分成 4 个字节 (Byte)，然后分别对每一个字节分析。</p><p>每一个字节有 8 位，也就是 256 种可能性。如果我们在收集 Nonce 的过程中，收集到了  某一个字节的这 256 种可能性。我们把这一个字节按位进行 XOR <span class="mathjax"><span class="MathJax_Preview" style="color: inherit;"></span><span class="MathJax" id="MathJax-Element-43-Frame" tabindex="0" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mo>&amp;#x2295;</mo></math>" role="presentation" style="position: relative;"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-323" style="width: 0.919em; display: inline-block;"><span style="display: inline-block; position: relative; width: 0.757em; height: 0px; font-size: 116%;"><span style="position: absolute; clip: rect(1.619em, 1000.7em, 2.643em, -999.997em); top: -2.368em; left: 0em;"><span class="mrow" id="MathJax-Span-324"><span class="mo" id="MathJax-Span-325" style="font-family: MathJax_Main;">⊕</span></span><span style="display: inline-block; width: 0px; height: 2.373em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.184em; border-left: 0px solid; width: 0px; height: 0.878em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mo>⊕</mo></math></span></span><script type="math/tex" id="MathJax-Element-43">\oplus</script></span> 运算，得到 1 位的输出，再和奇偶校验位 (Parity) 进行 XOR（注意这里的校验位 <span class="mathjax"><span class="MathJax_Preview" style="color: inherit;"></span><span class="MathJax" id="MathJax-Element-44-Frame" tabindex="0" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>p</mi><mi>i</mi></msub></math>" role="presentation" style="position: relative;"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-326" style="width: 0.973em; display: inline-block;"><span style="display: inline-block; position: relative; width: 0.811em; height: 0px; font-size: 116%;"><span style="position: absolute; clip: rect(1.781em, 1000.81em, 2.751em, -999.997em); top: -2.368em; left: 0em;"><span class="mrow" id="MathJax-Span-327"><span class="msubsup" id="MathJax-Span-328"><span style="display: inline-block; position: relative; width: 0.811em; height: 0px;"><span style="position: absolute; clip: rect(3.397em, 1000.49em, 4.367em, -999.997em); top: -3.984em; left: 0em;"><span class="mi" id="MathJax-Span-329" style="font-family: MathJax_Math-italic;">p</span><span style="display: inline-block; width: 0px; height: 3.99em;"></span></span><span style="position: absolute; top: -3.823em; left: 0.488em;"><span class="mi" id="MathJax-Span-330" style="font-size: 70.7%; font-family: MathJax_Math-italic;">i</span><span style="display: inline-block; width: 0px; height: 3.99em;"></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 2.373em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.309em; border-left: 0px solid; width: 0px; height: 0.878em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><msub><mi>p</mi><mi>i</mi></msub></math></span></span><script type="math/tex" id="MathJax-Element-44">p_i</script></span> 是和 keystream 进行了 XOR 运算后加密的），最终得到 1位 (bit) 的输出。由于我们对 256 种可能性进行计算，每种可能性计算得到的 1 bit 结果只能是 0 或者 1， 所以 S 最大是 256，最小是 0。</p><p><img src="" alt="img"></p><p>我们可能以为 S 的分布是比较均衡的，实际上可以看到在统计了 8192 个 Crypto1 的状态后，发现 S 并不是 [0, 256] 每种可能性都存在，甚至有些值，例如下图的 128 概率异常地高，这也就告诉我们 Crypto1 输出的 keystream 是存在某种概率分布的，这样我们就可以用 Cryptanalysis 的一些方法进行分析，剔除掉可能性非常低的密钥 <span class="mathjax"><span class="MathJax_Preview" style="color: inherit;"></span><span class="MathJax" id="MathJax-Element-45-Frame" tabindex="0" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>K</mi></math>" role="presentation" style="position: relative;"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-331" style="width: 1.08em; display: inline-block;"><span style="display: inline-block; position: relative; width: 0.919em; height: 0px; font-size: 116%;"><span style="position: absolute; clip: rect(1.511em, 1000.92em, 2.535em, -999.997em); top: -2.368em; left: 0em;"><span class="mrow" id="MathJax-Span-332"><span class="mi" id="MathJax-Span-333" style="font-family: MathJax_Math-italic;">K<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.057em;"></span></span></span><span style="display: inline-block; width: 0px; height: 2.373em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.059em; border-left: 0px solid; width: 0px; height: 0.941em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>K</mi></math></span></span><script type="math/tex" id="MathJax-Element-45">K</script></span>，减少搜寻空间。</p><p><img src="" alt="img"></p><p>实际操作时，由于之前提到 Crypto1 的加密算法用到的 Filter Function 只利用了奇数位，我们可以把奇偶位的 Sum Property 分开计算。</p><p><img src="" alt="img"></p><p>只有满足下面公式 <span class="mathjax"><span class="MathJax_Preview" style="color: inherit;"></span><span class="MathJax" id="MathJax-Element-46-Frame" tabindex="0" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>s</mi><mo>=</mo><mi>p</mi><mo stretchy=&quot;false&quot;>(</mo><mn>16</mn><mo>&amp;#x2212;</mo><mi>q</mi><mo stretchy=&quot;false&quot;>)</mo><mo>+</mo><mi>q</mi><mo stretchy=&quot;false&quot;>(</mo><mn>16</mn><mo>&amp;#x2212;</mo><mi>p</mi><mo stretchy=&quot;false&quot;>)</mo></math>" role="presentation" style="position: relative;"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-334" style="width: 12.664em; display: inline-block;"><span style="display: inline-block; position: relative; width: 10.886em; height: 0px; font-size: 116%;"><span style="position: absolute; clip: rect(1.457em, 1010.78em, 2.804em, -999.997em); top: -2.368em; left: 0em;"><span class="mrow" id="MathJax-Span-335"><span class="mi" id="MathJax-Span-336" style="font-family: MathJax_Math-italic;">s</span><span class="mo" id="MathJax-Span-337" style="font-family: MathJax_Main; padding-left: 0.272em;">=</span><span class="mi" id="MathJax-Span-338" style="font-family: MathJax_Math-italic; padding-left: 0.272em;">p</span><span class="mo" id="MathJax-Span-339" style="font-family: MathJax_Main;">(</span><span class="mn" id="MathJax-Span-340" style="font-family: MathJax_Main;">16</span><span class="mo" id="MathJax-Span-341" style="font-family: MathJax_Main; padding-left: 0.218em;">−</span><span class="mi" id="MathJax-Span-342" style="font-family: MathJax_Math-italic; padding-left: 0.218em;">q<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.003em;"></span></span><span class="mo" id="MathJax-Span-343" style="font-family: MathJax_Main;">)</span><span class="mo" id="MathJax-Span-344" style="font-family: MathJax_Main; padding-left: 0.218em;">+</span><span class="mi" id="MathJax-Span-345" style="font-family: MathJax_Math-italic; padding-left: 0.218em;">q<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.003em;"></span></span><span class="mo" id="MathJax-Span-346" style="font-family: MathJax_Main;">(</span><span class="mn" id="MathJax-Span-347" style="font-family: MathJax_Main;">16</span><span class="mo" id="MathJax-Span-348" style="font-family: MathJax_Main; padding-left: 0.218em;">−</span><span class="mi" id="MathJax-Span-349" style="font-family: MathJax_Math-italic; padding-left: 0.218em;">p</span><span class="mo" id="MathJax-Span-350" style="font-family: MathJax_Main;">)</span></span><span style="display: inline-block; width: 0px; height: 2.373em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.372em; border-left: 0px solid; width: 0px; height: 1.316em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>s</mi><mo>=</mo><mi>p</mi><mo stretchy="false">(</mo><mn>16</mn><mo>−</mo><mi>q</mi><mo stretchy="false">)</mo><mo>+</mo><mi>q</mi><mo stretchy="false">(</mo><mn>16</mn><mo>−</mo><mi>p</mi><mo stretchy="false">)</mo></math></span></span><script type="math/tex" id="MathJax-Element-46">s=p(16-q)+q(16-p)</script></span> 的 Ctypto1 内部状态才是有效的，于是我们就可以剔除掉很大一部分搜寻空间。</p><p><img src="" alt="img"></p><h3 id="2-Filter-Flip" style=""><a class="anchor hidden-xs" href="#2-Filter-Flip" title="2-Filter-Flip"><i class="fa fa-link"></i></a>2. Filter Flip</h3><p>Crypto1 Stream Cipher 在生成最终用来加密的 keystream 前，需要把内部 48 位的状态通过一个非线性 Filter Function，也就是下面这张图定义的。</p><p><img src="" alt="img"></p><p>Garcia 发现，上面的 Filter Function 满足下面的特性：如果两个 32 位的 <span class="mathjax"><span class="MathJax_Preview" style="color: inherit;"></span><span class="MathJax" id="MathJax-Element-67-Frame" tabindex="0" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msub><mi>n</mi><mi>T</mi></msub></math>" role="presentation" style="position: relative;"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-465" style="width: 1.404em; display: inline-block;"><span style="display: inline-block; position: relative; width: 1.188em; height: 0px; font-size: 116%;"><span style="position: absolute; clip: rect(1.781em, 1001.19em, 2.697em, -999.997em); top: -2.368em; left: 0em;"><span class="mrow" id="MathJax-Span-466"><span class="msubsup" id="MathJax-Span-467"><span style="display: inline-block; position: relative; width: 1.188em; height: 0px;"><span style="position: absolute; clip: rect(3.397em, 1000.6em, 4.151em, -999.997em); top: -3.984em; left: 0em;"><span class="mi" id="MathJax-Span-468" style="font-family: MathJax_Math-italic;">n</span><span style="display: inline-block; width: 0px; height: 3.99em;"></span></span><span style="position: absolute; top: -3.823em; left: 0.595em;"><span class="mi" id="MathJax-Span-469" style="font-size: 70.7%; font-family: MathJax_Math-italic;">T<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.11em;"></span></span><span style="display: inline-block; width: 0px; height: 3.99em;"></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 2.373em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.247em; border-left: 0px solid; width: 0px; height: 0.816em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><msub><mi>n</mi><mi>T</mi></msub></math></span></span><script type="math/tex" id="MathJax-Element-67">n_T</script></span> 和 <span class="mathjax"><span class="MathJax_Preview" style="color: inherit;"></span><span class="MathJax" id="MathJax-Element-68-Frame" tabindex="0" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msubsup><mi>n</mi><mi>T</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><msup><mi></mi><mo>&amp;#x2032;</mo></msup></mrow></msubsup></math>" role="presentation" style="position: relative;"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-470" style="width: 1.404em; display: inline-block;"><span style="display: inline-block; position: relative; width: 1.188em; height: 0px; font-size: 116%;"><span style="position: absolute; clip: rect(1.35em, 1001.19em, 2.858em, -999.997em); top: -2.368em; left: 0em;"><span class="mrow" id="MathJax-Span-471"><span class="msubsup" id="MathJax-Span-472"><span style="display: inline-block; position: relative; width: 1.188em; height: 0px;"><span style="position: absolute; clip: rect(3.397em, 1000.6em, 4.151em, -999.997em); top: -3.984em; left: 0em;"><span class="mi" id="MathJax-Span-473" style="font-family: MathJax_Math-italic;">n</span><span style="display: inline-block; width: 0px; height: 3.99em;"></span></span><span style="position: absolute; clip: rect(3.289em, 1000.27em, 4.151em, -999.997em); top: -4.308em; left: 0.595em;"><span class="texatom" id="MathJax-Span-474"><span class="mrow" id="MathJax-Span-475"><span class="msup" id="MathJax-Span-476"><span style="display: inline-block; position: relative; width: 0.218em; height: 0px;"><span style="position: absolute; clip: rect(3.828em, 1000em, 4.151em, -999.997em); top: -3.984em; left: 0em;"><span class="mi" id="MathJax-Span-477" style="font-size: 70.7%;"></span><span style="display: inline-block; width: 0px; height: 3.99em;"></span></span><span style="position: absolute; top: -4.254em; left: 0em;"><span class="mo" id="MathJax-Span-478" style="font-size: 50%; font-family: MathJax_Main;">′</span><span style="display: inline-block; width: 0px; height: 3.99em;"></span></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 3.99em;"></span></span><span style="position: absolute; clip: rect(3.343em, 1000.6em, 4.151em, -999.997em); top: -3.661em; left: 0.595em;"><span class="mi" id="MathJax-Span-479" style="font-size: 70.7%; font-family: MathJax_Math-italic;">T<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.11em;"></span></span><span style="display: inline-block; width: 0px; height: 3.99em;"></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 2.373em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.434em; border-left: 0px solid; width: 0px; height: 1.503em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><msubsup><mi>n</mi><mi>T</mi><mrow class="MJX-TeXAtom-ORD"><msup><mi></mi><mo>′</mo></msup></mrow></msubsup></math></span></span><script type="math/tex" id="MathJax-Element-68">n_T^{'}</script></span>，如果前面 3 个字节 (byte) 都一样，只反转最后一位 (bit)，并且最终的奇偶校验位 <span class="mathjax"><span class="MathJax_Preview" style="color: inherit;"></span><span class="MathJax" id="MathJax-Element-69-Frame" tabindex="0" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mo fence=&quot;false&quot; stretchy=&quot;false&quot;>{</mo><msub><mi>p</mi><mi>i</mi></msub><mo fence=&quot;false&quot; stretchy=&quot;false&quot;>}</mo></math>" role="presentation" style="position: relative;"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-480" style="width: 2.158em; display: inline-block;"><span style="display: inline-block; position: relative; width: 1.835em; height: 0px; font-size: 116%;"><span style="position: absolute; clip: rect(1.457em, 1001.78em, 2.804em, -999.997em); top: -2.368em; left: 0em;"><span class="mrow" id="MathJax-Span-481"><span class="mo" id="MathJax-Span-482" style="font-family: MathJax_Main;">{</span><span class="msubsup" id="MathJax-Span-483"><span style="display: inline-block; position: relative; width: 0.811em; height: 0px;"><span style="position: absolute; clip: rect(3.397em, 1000.49em, 4.367em, -999.997em); top: -3.984em; left: 0em;"><span class="mi" id="MathJax-Span-484" style="font-family: MathJax_Math-italic;">p</span><span style="display: inline-block; width: 0px; height: 3.99em;"></span></span><span style="position: absolute; top: -3.823em; left: 0.488em;"><span class="mi" id="MathJax-Span-485" style="font-size: 70.7%; font-family: MathJax_Math-italic;">i</span><span style="display: inline-block; width: 0px; height: 3.99em;"></span></span></span></span><span class="mo" id="MathJax-Span-486" style="font-family: MathJax_Main;">}</span></span><span style="display: inline-block; width: 0px; height: 2.373em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.372em; border-left: 0px solid; width: 0px; height: 1.316em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mo fence="false" stretchy="false">{</mo><msub><mi>p</mi><mi>i</mi></msub><mo fence="false" stretchy="false">}</mo></math></span></span><script type="math/tex" id="MathJax-Element-69">\{p_i\}</script></span> 和 <span class="mathjax"><span class="MathJax_Preview" style="color: inherit;"></span><span class="MathJax" id="MathJax-Element-70-Frame" tabindex="0" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mo fence=&quot;false&quot; stretchy=&quot;false&quot;>{</mo><msubsup><mi>p</mi><mi>i</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><msup><mi></mi><mo>&amp;#x2032;</mo></msup></mrow></msubsup><mo fence=&quot;false&quot; stretchy=&quot;false&quot;>}</mo></math>" role="presentation" style="position: relative;"><nobr aria-hidden="true"><span class="math" id="MathJax-Span-487" style="width: 2.158em; display: inline-block;"><span style="display: inline-block; position: relative; width: 1.835em; height: 0px; font-size: 116%;"><span style="position: absolute; clip: rect(1.35em, 1001.78em, 2.858em, -999.997em); top: -2.368em; left: 0em;"><span class="mrow" id="MathJax-Span-488"><span class="mo" id="MathJax-Span-489" style="font-family: MathJax_Main;">{</span><span class="msubsup" id="MathJax-Span-490"><span style="display: inline-block; position: relative; width: 0.811em; height: 0px;"><span style="position: absolute; clip: rect(3.397em, 1000.49em, 4.367em, -999.997em); top: -3.984em; left: 0em;"><span class="mi" id="MathJax-Span-491" style="font-family: MathJax_Math-italic;">p</span><span style="display: inline-block; width: 0px; height: 3.99em;"></span></span><span style="position: absolute; clip: rect(3.289em, 1000.27em, 4.151em, -999.997em); top: -4.308em; left: 0.488em;"><span class="texatom" id="MathJax-Span-492"><span class="mrow" id="MathJax-Span-493"><span class="msup" id="MathJax-Span-494"><span style="display: inline-block; position: relative; width: 0.218em; height: 0px;"><span style="position: absolute; clip: rect(3.828em, 1000em, 4.151em, -999.997em); top: -3.984em; left: 0em;"><span class="mi" id="MathJax-Span-495" style="font-size: 70.7%;"></span><span style="display: inline-block; width: 0px; height: 3.99em;"></span></span><span style="position: absolute; top: -4.254em; left: 0em;"><span class="mo" id="MathJax-Span-496" style="font-size: 50%; font-family: MathJax_Main;">′</span><span style="display: inline-block; width: 0px; height: 3.99em;"></span></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 3.99em;"></span></span><span style="position: absolute; clip: rect(3.343em, 1000.33em, 4.151em, -999.997em); top: -3.661em; left: 0.488em;"><span class="mi" id="MathJax-Span-497" style="font-size: 70.7%; font-family: MathJax_Math-italic;">i</span><span style="display: inline-block; width: 0px; height: 3.99em;"></span></span></span></span><span class="mo" id="MathJax-Span-498" style="font-family: MathJax_Main;">}</span></span><span style="display: inline-block; width: 0px; height: 2.373em;"></span></span></span><span style="display: inline-block; overflow: hidden; vertical-align: -0.434em; border-left: 0px solid; width: 0px; height: 1.503em;"></span></span></nobr><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mo fence="false" stretchy="false">{</mo><msubsup><mi>p</mi><mi>i</mi><mrow class="MJX-TeXAtom-ORD"><msup><mi></mi><mo>′</mo></msup></mrow></msubsup><mo fence="false" stretchy="false">}</mo></math></span></span><script type="math/tex" id="MathJax-Element-70">\{p_i^{'}\}</script></span> 也是一样的，那么它们经过 Filter Function 后的输出必然是不同的：$f(\alpha_{8i+8}) \neq f(\alpha_{8i+8} \oplus 1) $。</p><p><img src="" alt="img"></p><p>Garcia 通过实验表明，整个搜寻空间中，大约只有 9.4% 的输入有这个特性，于是每次观察到搜集的 Nonce 出现了 Filter Flip，我们就可以进一步缩小搜寻空间，只暴力破解满足这个特性的 9.4% 个输入。</p><h2 id="总结" style=""><a class="anchor hidden-xs" href="#总结" title="总结"><i class="fa fa-link"></i></a>总结</h2><p>最后总结一下，尽管 NXP 在 1994 年发布的时候，并没有公开 M1 卡加密的细节，最终在 2008 年被人利用 PRNG 的漏洞，找到了 Authentication 设计的纰漏。因为没有破解核心的 Crypto1 算法，NXP 迅速打补丁修复 Authentication 的漏洞，勉强维持了 M1 卡的安全性。然而终于还是在 2015 年被人利用密码分析学，分析密文的特征，成功在 1 分钟左右破解得到密钥，也彻底宣告了 Crypto1 生命的终结。</p><blockquote>
<p>The paradox of keeping things secret.</p>
</blockquote><p>NXP 设计的 M1 卡在发布 20 年后终于被完全破解的故事，告诉我们 <strong>千万不要使用未经公开的加密算法</strong> (例如 NXP 偷偷设计的 Crypto1)，只有算法加密细节完全公开，并且经过学术界、工业界研究多年，仍未找到比 暴力破解 (Brute Force) 显著更优的破解方式，才是真正的安全。</p><h2 id="参考资料" style=""><a class="anchor hidden-xs" href="#参考资料" title="参考资料"><i class="fa fa-link"></i></a>参考资料</h2><p>[1] Garcia, Flavio D., et al. "Dismantling MIFARE Classic."<em>ESORICS</em>. Vol. 5283. 2008.</p><p>[2] Meijer, Carlo, and Roel Verdult. "Ciphertext-only cryptanalysis on hardened Mifare classic cards."<em>Proceedings of the 22nd ACM SIGSAC Conference on Computer and Communications Security</em>. 2015.</p><p>[3] Garcia, Flavio D., et al. "Wirelessly pickpocketing a Mifare Classic card."<em>2009 30th IEEE Symposium on Security and Privacy</em>. IEEE, 2009.</p></div>
    <div class="ui-toc dropup unselectable hidden-print" style="display:none;">
        <div class="pull-right dropdown">
            <a id="tocLabel" class="ui-toc-label btn btn-default" data-toggle="dropdown" href="#" role="button" aria-haspopup="true" aria-expanded="false" title="Table of content">
                <i class="fa fa-bars"></i>
            </a>
            <ul id="ui-toc" class="ui-toc-dropdown dropdown-menu" aria-labelledby="tocLabel">
                <div class="toc"><ul class="nav">
<li class=""><a href="#CRYPTO1-密码分析学-门禁卡破解" title="CRYPTO1: 密码分析学 (门禁卡破解)">CRYPTO1: 密码分析学 (门禁卡破解)</a><ul class="nav">
<li><a href="#介绍：NFC-开源软硬件" title="介绍：NFC 开源软硬件">介绍：NFC 开源软硬件</a></li>
<li><a href="#介绍：M1-卡数据存储" title="介绍：M1 卡数据存储">介绍：M1 卡数据存储</a></li>
<li><a href="#介绍：M1-卡数据加密" title="介绍：M1 卡数据加密">介绍：M1 卡数据加密</a><ul class="nav">
<li><a href="#1-Authentication" title="1. Authentication">1. Authentication</a></li>
<li><a href="#2-Encryption" title="2. Encryption">2. Encryption</a></li>
</ul>
</li>
<li><a href="#破解1：UID-复制" title="破解1：UID 复制">破解1：UID 复制</a></li>
<li><a href="#破解2：Authentication" title="破解2：Authentication">破解2：Authentication</a></li>
<li class=""><a href="#破解3：Crypto1" title="破解3：Crypto1">破解3：Crypto1</a><ul class="nav">
<li><a href="#1-Sum-Property" title="1. Sum Property">1. Sum Property</a></li>
<li class=""><a href="#2-Filter-Flip" title="2. Filter Flip">2. Filter Flip</a></li>
</ul>
</li>
<li><a href="#总结" title="总结">总结</a></li>
<li class=""><a href="#参考资料" title="参考资料">参考资料</a></li>
</ul>
</li>
</ul>
</div><div class="toc-menu"><a class="expand-toggle" href="#">Expand all</a><a class="back-to-top" href="#">Back to top</a><a class="go-to-bottom" href="#">Go to bottom</a></div>
            </ul>
        </div>
    </div>
    <div id="ui-toc-affix" class="ui-affix-toc ui-toc-dropdown unselectable hidden-print" data-spy="affix" style="top:17px;display:none;"  >
        <div class="toc"><ul class="nav">
<li class=""><a href="#CRYPTO1-密码分析学-门禁卡破解" title="CRYPTO1: 密码分析学 (门禁卡破解)">CRYPTO1: 密码分析学 (门禁卡破解)</a><ul class="nav">
<li><a href="#介绍：NFC-开源软硬件" title="介绍：NFC 开源软硬件">介绍：NFC 开源软硬件</a></li>
<li><a href="#介绍：M1-卡数据存储" title="介绍：M1 卡数据存储">介绍：M1 卡数据存储</a></li>
<li><a href="#介绍：M1-卡数据加密" title="介绍：M1 卡数据加密">介绍：M1 卡数据加密</a><ul class="nav">
<li><a href="#1-Authentication" title="1. Authentication">1. Authentication</a></li>
<li><a href="#2-Encryption" title="2. Encryption">2. Encryption</a></li>
</ul>
</li>
<li><a href="#破解1：UID-复制" title="破解1：UID 复制">破解1：UID 复制</a></li>
<li><a href="#破解2：Authentication" title="破解2：Authentication">破解2：Authentication</a></li>
<li class=""><a href="#破解3：Crypto1" title="破解3：Crypto1">破解3：Crypto1</a><ul class="nav">
<li><a href="#1-Sum-Property" title="1. Sum Property">1. Sum Property</a></li>
<li class=""><a href="#2-Filter-Flip" title="2. Filter Flip">2. Filter Flip</a></li>
</ul>
</li>
<li><a href="#总结" title="总结">总结</a></li>
<li class=""><a href="#参考资料" title="参考资料">参考资料</a></li>
</ul>
</li>
</ul>
</div><div class="toc-menu"><a class="expand-toggle" href="#">Expand all</a><a class="back-to-top" href="#">Back to top</a><a class="go-to-bottom" href="#">Go to bottom</a></div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.0/js/bootstrap.min.js" integrity="sha256-kJrlY+s09+QoWjpkOrXXwhxeaoDz9FW5SaxF8I0DibQ=" crossorigin="anonymous" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gist-embed/2.6.0/gist-embed.min.js" integrity="sha256-KyF2D6xPIJUW5sUDSs93vWyZm+1RzIpKCexxElmxl8g=" crossorigin="anonymous" defer></script>
    <script>
        var markdown = $(".markdown-body");
        //smooth all hash trigger scrolling
        function smoothHashScroll() {
            var hashElements = $("a[href^='#']").toArray();
            for (var i = 0; i < hashElements.length; i++) {
                var element = hashElements[i];
                var $element = $(element);
                var hash = element.hash;
                if (hash) {
                    $element.on('click', function (e) {
                        // store hash
                        var hash = this.hash;
                        if ($(hash).length <= 0) return;
                        // prevent default anchor click behavior
                        e.preventDefault();
                        // animate
                        $('body, html').stop(true, true).animate({
                            scrollTop: $(hash).offset().top
                        }, 100, "linear", function () {
                            // when done, add hash to url
                            // (default click behaviour)
                            window.location.hash = hash;
                        });
                    });
                }
            }
        }

        smoothHashScroll();
        var toc = $('.ui-toc');
        var tocAffix = $('.ui-affix-toc');
        var tocDropdown = $('.ui-toc-dropdown');
        //toc
        tocDropdown.click(function (e) {
            e.stopPropagation();
        });

        var enoughForAffixToc = true;

        function generateScrollspy() {
            $(document.body).scrollspy({
                target: ''
            });
            $(document.body).scrollspy('refresh');
            if (enoughForAffixToc) {
                toc.hide();
                tocAffix.show();
            } else {
                tocAffix.hide();
                toc.show();
            }
            $(document.body).scroll();
        }

        function windowResize() {
            //toc right
            var paddingRight = parseFloat(markdown.css('padding-right'));
            var right = ($(window).width() - (markdown.offset().left + markdown.outerWidth() - paddingRight));
            toc.css('right', right + 'px');
            //affix toc left
            var newbool;
            var rightMargin = (markdown.parent().outerWidth() - markdown.outerWidth()) / 2;
            //for ipad or wider device
            if (rightMargin >= 133) {
                newbool = true;
                var affixLeftMargin = (tocAffix.outerWidth() - tocAffix.width()) / 2;
                var left = markdown.offset().left + markdown.outerWidth() - affixLeftMargin;
                tocAffix.css('left', left + 'px');
            } else {
                newbool = false;
            }
            if (newbool != enoughForAffixToc) {
                enoughForAffixToc = newbool;
                generateScrollspy();
            }
        }
        $(window).resize(function () {
            windowResize();
        });
        $(document).ready(function () {
            windowResize();
            generateScrollspy();
        });

        //remove hash
        function removeHash() {
            window.location.hash = '';
        }

        var backtotop = $('.back-to-top');
        var gotobottom = $('.go-to-bottom');

        backtotop.click(function (e) {
            e.preventDefault();
            e.stopPropagation();
            if (scrollToTop)
                scrollToTop();
            removeHash();
        });
        gotobottom.click(function (e) {
            e.preventDefault();
            e.stopPropagation();
            if (scrollToBottom)
                scrollToBottom();
            removeHash();
        });

        var toggle = $('.expand-toggle');
        var tocExpand = false;

        checkExpandToggle();
        toggle.click(function (e) {
            e.preventDefault();
            e.stopPropagation();
            tocExpand = !tocExpand;
            checkExpandToggle();
        })

        function checkExpandToggle () {
            var toc = $('.ui-toc-dropdown .toc');
            var toggle = $('.expand-toggle');
            if (!tocExpand) {
                toc.removeClass('expand');
                toggle.text('Expand all');
            } else {
                toc.addClass('expand');
                toggle.text('Collapse all');
            }
        }

        function scrollToTop() {
            $('body, html').stop(true, true).animate({
                scrollTop: 0
            }, 100, "linear");
        }

        function scrollToBottom() {
            $('body, html').stop(true, true).animate({
                scrollTop: $(document.body)[0].scrollHeight
            }, 100, "linear");
        }
    </script>
</body>

</html>
